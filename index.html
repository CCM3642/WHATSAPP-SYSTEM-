<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>Advanced Customer Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Comprehensive CRM system for customer management and engagement">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #28a745, #20c997);
      --warning-gradient: linear-gradient(135deg, #ffc107, #ff9800);
      --danger-gradient: linear-gradient(135deg, #dc3545, #fd7e14);
      --info-gradient: linear-gradient(135deg, #17a2b8, #6c757d);
      --dark-gradient: linear-gradient(135deg, #343a40, #495057);
      
      /* Light theme colors */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #e9ecef;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --border-color: #dee2e6;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #404040;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --border-color: #404040;
      --shadow-color: rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      color: var(--text-primary);
      background-color: var(--bg-primary);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] body {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    }

    /* Sidebar Navigation */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 250px;
      background: var(--dark-gradient);
      color: white;
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .sidebar.collapsed {
      transform: translateX(-250px);
    }

    .sidebar-header {
      padding: 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
    }

    .sidebar-menu li {
      margin-bottom: 10px;
    }

    .sidebar-menu a {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      padding: 12px 15px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      transition: all 0.3s;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .sidebar-menu i {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    /* Main Content */
    .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    .main-content.expanded {
      margin-left: 0;
    }

    /* Header */
    .header {
      background: var(--bg-primary);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 5px 20px var(--shadow-color);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .menu-toggle {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 15px;
      margin-right: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }

    /* Theme Toggle */
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 15px var(--shadow-color);
      z-index: 1000;
      transition: all 0.3s;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-primary);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 3px 10px var(--shadow-color);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px var(--shadow-color);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 2.5rem;
      opacity: 0.1;
      color: #667eea;
    }

    /* Content Cards */
    .content-card {
      background: var(--bg-primary);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 5px 20px var(--shadow-color);
    }

    .card-header-custom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
      flex-wrap: wrap;
      gap: 10px;
    }

    /* Forms */
    .form-floating-custom {
      position: relative;
      margin-bottom: 20px;
    }

    .form-control-custom {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .form-control-custom:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .filter-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    /* Buttons */
    .btn-gradient {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 25px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .btn-success-gradient {
      background: var(--success-gradient);
    }

    .btn-danger-gradient {
      background: var(--danger-gradient);
    }

    /* Data Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table thead {
      background: var(--primary-gradient);
      color: white;
    }

    .data-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 1px;
      cursor: pointer;
      user-select: none;
    }

    .data-table th:hover {
      background: rgba(255,255,255,0.1);
    }

    .data-table td {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table tbody tr {
      transition: all 0.2s;
    }

    .data-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    /* Virtual Scroll Container */
    .virtual-scroll-container {
      height: 500px;
      overflow-y: auto;
      position: relative;
    }

    .virtual-scroll-content {
      position: relative;
    }

    /* Status Badges */
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-active {
      background: var(--success-gradient);
      color: white;
    }

    .status-inactive {
      background: var(--warning-gradient);
      color: white;
    }

    .status-optout {
      background: var(--danger-gradient);
      color: white;
    }

    /* Customer Tags */
    .customer-tags {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-top: 5px;
    }

    .tag {
      padding: 3px 8px;
      background: var(--bg-tertiary);
      border-radius: 5px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .tag.premium {
      background: var(--warning-gradient);
      color: white;
    }

    .tag.vip {
      background: var(--primary-gradient);
      color: white;
    }

    .tag.new {
      background: var(--success-gradient);
      color: white;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .btn-action {
      padding: 5px 10px;
      border-radius: 5px;
      border: none;
      font-size: 0.9rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    .btn-action:hover {
      transform: scale(1.1);
    }

    /* Pagination */
    .pagination-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination-btn {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-btn.active {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    /* Message Progress */
    .message-progress {
      background: var(--bg-secondary);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .message-progress.active {
      display: block;
    }

    .progress-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: var(--bg-primary);
      border-radius: 8px;
      transition: all 0.3s;
    }

    .progress-item.sending {
      background: #fff3cd;
    }

    .progress-item.sent {
      background: #d4edda;
    }

    .progress-item.failed {
      background: #f8d7da;
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }

    /* Modal Customizations */
    .modal-content {
      border-radius: 20px;
      border: none;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .modal-header {
      background: var(--primary-gradient);
      color: white;
      border-radius: 20px 20px 0 0;
      border: none;
    }

    .modal-header .btn-close {
      filter: brightness(0) invert(1);
    }

    .modal-body {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    /* Loading Spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    [data-theme="dark"] .loading-overlay {
      background: rgba(0,0,0,0.95);
    }

    .loading-overlay.active {
      display: flex;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .custom-toast {
      min-width: 300px;
      border-radius: 15px;
      box-shadow: 0 5px 20px var(--shadow-color);
    }

    /* WhatsApp Links */
    .whatsapp-links {
      background: var(--bg-secondary);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .whatsapp-links.active {
      display: block;
    }

    .whatsapp-link-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: var(--bg-primary);
      border-radius: 8px;
      transition: all 0.3s;
    }

    .whatsapp-link-item:hover {
      transform: translateX(5px);
      box-shadow: 0 3px 10px var(--shadow-color);
    }

    /* Activity Feed */
    .activity-feed {
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      padding: 10px;
      margin-bottom: 10px;
      background: var(--bg-secondary);
      border-left: 3px solid var(--primary-gradient);
    }

    .activity-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* Follow-up Reminders */
    .follow-up-item {
      padding: 15px;
      margin-bottom: 10px;
      background: var(--bg-secondary);
      border-left: 3px solid var(--warning-gradient);
    }

    .follow-up-item.overdue {
      border-left-color: var(--danger-gradient);
      background: rgba(220, 53, 69, 0.1);
    }

    /* Customer Lifecycle */
    .lifecycle-stage {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 5px;
    }

    .stage-lead { background: #6c757d; color: white; }
    .stage-prospect { background: #17a2b8; color: white; }
    .stage-active { background: #28a745; color: white; }
    .stage-churned { background: #dc3545; color: white; }
    .stage-reactivated { background: #ffc107; color: black; }

    /* Task Management */
    .task-item {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-color);
    }

    .task-item.completed {
      opacity: 0.7;
      text-decoration: line-through;
    }

    .task-priority {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .priority-low { background: #28a745; color: white; }
    .priority-medium { background: #ffc107; color: black; }
    .priority-high { background: #fd7e14; color: white; }
    .priority-urgent { background: #dc3545; color: white; }

    /* Search Suggestions */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 10px var(--shadow-color);
    }

    .suggestion-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestion-item:hover {
      background: var(--bg-secondary);
    }

    /* Rule Builder */
    .rule-builder {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 15px;
      margin-top: 10px;
    }

    .rule-container {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .rule-field, .rule-operator, .rule-value {
      flex: 1;
    }

    /* Template Manager */
    .template-manager {
      max-height: 400px;
      overflow-y: auto;
    }

    .template-item {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .template-actions {
      margin-top: 10px;
    }

    /* Export Options */
    .export-options {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .export-field {
      margin-right: 15px;
    }

    /* Voice Commands */
    .voice-indicator {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: var(--primary-gradient);
      color: white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px var(--shadow-color);
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s;
    }

    .voice-indicator.active {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Debug Info */
    .debug-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
      font-family: monospace;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-250px);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .header-top {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .data-table {
        font-size: 0.875rem;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .search-filters {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        height: 250px;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    /* Accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    *:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .btn-gradient {
        border: 2px solid currentColor;
      }
      
      .stat-card {
        border: 2px solid var(--border-color);
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <!-- Skip to main content for accessibility -->
  <a href="#mainContent" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-600 text-white px-4 py-2 rounded">
    Skip to main content
  </a>

  <!-- Debug Info -->
  <div class="debug-info" id="debugInfo" aria-live="polite">Initializing...</div>

  <!-- Sidebar Navigation -->
  <nav class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
    <div class="sidebar-header">
      <h4><i class="bi bi-people-fill me-2" aria-hidden="true"></i>CRM System</h4>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" class="active" onclick="showSection('dashboard')" aria-current="page"><i class="bi bi-speedometer2" aria-hidden="true"></i> Dashboard</a></li>
      <li><a href="#" onclick="showSection('customers')"><i class="bi bi-people" aria-hidden="true"></i> Customers</a></li>
      <li><a href="#" onclick="showSection('add-customer')"><i class="bi bi-person-plus" aria-hidden="true"></i> Add Customer</a></li>
      <li><a href="#" onclick="showSection('messaging')"><i class="bi bi-chat-dots" aria-hidden="true"></i> Messaging</a></li>
      <li><a href="#" onclick="showSection('analytics')"><i class="bi bi-graph-up" aria-hidden="true"></i> Analytics</a></li>
      <li><a href="#" onclick="showSection('followups')"><i class="bi bi-calendar-check" aria-hidden="true"></i> Follow-ups</a></li>
      <li><a href="#" onclick="showSection('tasks')"><i class="bi bi-list-check" aria-hidden="true"></i> Tasks</a></li>
      <li><a href="#" onclick="showSection('portal')"><i class="bi bi-globe" aria-hidden="true"></i> Portal</a></li>
      <li><a href="#" onclick="showSection('settings')"><i class="bi bi-sliders" aria-hidden="true"></i> Settings</a></li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <!-- Header -->
    <header class="header">
      <div class="header-top">
        <div style="display: flex; align-items: center;">
          <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
            <i class="bi bi-list" aria-hidden="true"></i>
          </button>
          <h2 class="mb-0">Customer Management System</h2>
        </div>
        <div>
          <button class="btn btn-gradient me-2" onclick="showExportModal()" aria-label="Export data">
            <i class="bi bi-download me-2" aria-hidden="true"></i>Export
          </button>
          <button class="btn btn-success-gradient" onclick="quickAddCustomer()" aria-label="Quick add customer">
            <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>Quick Add
          </button>
        </div>
      </div>
    </header>

    <!-- Dashboard Section -->
    <section id="dashboard-section" class="section" aria-labelledby="dashboard-heading">
      <h2 id="dashboard-heading" class="sr-only">Dashboard</h2>
      
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalCustomers" aria-live="polite">0</div>
          <div class="stat-label">Total Customers</div>
          <i class="bi bi-people stat-icon" aria-hidden="true"></i>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeCustomers" aria-live="polite">0</div>
          <div class="stat-label">Active</div>
          <i class="bi bi-person-check stat-icon" aria-hidden="true"></i>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="newThisMonth" aria-live="polite">0</div>
          <div class="stat-label">New This Month</div>
          <i class="bi bi-calendar-plus stat-icon" aria-hidden="true"></i>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="messagesSent" aria-live="polite">0</div>
          <div class="stat-label">Messages Sent</div>
          <i class="bi bi-send stat-icon" aria-hidden="true"></i>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="followupCount" aria-live="polite">0</div>
          <div class="stat-label">Pending Follow-ups</div>
          <i class="bi bi-calendar-check stat-icon" aria-hidden="true"></i>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="retentionRate" aria-live="polite">0%</div>
          <div class="stat-label">Retention Rate</div>
          <i class="bi-graph-up-arrow stat-icon" aria-hidden="true"></i>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="content-card">
        <h3 class="mb-3">Quick Actions</h3>
        <div class="quick-actions">
          <button class="btn btn-gradient me-2" onclick="showSection('add-customer')">
            <i class="bi bi-person-plus me-2" aria-hidden="true"></i>Add Customer
          </button>
          <button class="btn btn-gradient me-2" onclick="showSection('messaging')">
            <i class="bi bi-chat-dots me-2" aria-hidden="true"></i>Send Message
          </button>
          <button class="btn btn-gradient me-2" onclick="showSection('analytics')">
            <i class="bi bi-graph-up me-2" aria-hidden="true"></i>Analytics
          </button>
          <button class="btn btn-gradient me-2" onclick="generateReport()">
            <i class="bi bi-file-earmark-text me-2" aria-hidden="true"></i>Report
          </button>
          <button class="btn btn-gradient me-2" onclick="backupData()">
            <i class="bi bi-cloud-download me-2" aria-hidden="true"></i>Backup
          </button>
          <button class="btn btn-gradient me-2" onclick="showImportModal()">
            <i class="bi bi-upload me-2" aria-hidden="true"></i>Import
          </button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="content-card">
        <h3 class="mb-3">Recent Activity</h3>
        <div class="activity-feed" id="recentActivity" role="log" aria-live="polite">
          <p class="text-muted">No recent activity</p>
        </div>
      </div>
    </section>

    <!-- Customers Section -->
    <section id="customers-section" class="section" style="display: none;" aria-labelledby="customers-heading">
      <h2 id="customers-heading" class="sr-only">Customers</h2>
      
      <div class="content-card">
        <h3 class="mb-3">Customer List</h3>
        
        <!-- Advanced Search -->
        <div class="content-card">
          <h5 class="mb-3">Advanced Search</h5>
          <div class="search-filters">
            <div class="row">
              <div class="col-md-3 position-relative">
                <label class="filter-label">Name</label>
                <input type="text" class="form-control-custom" id="searchName" placeholder="Search by name..." onkeyup="optimizedSearch()">
                <div class="search-suggestions" id="nameSuggestions"></div>
              </div>
              <div class="col-md-3">
                <label class="filter-label">Phone</label>
                <input type="tel" class="form-control-custom" id="searchPhone" placeholder="Search by phone..." onkeyup="optimizedSearch()">
              </div>
              <div class="col-md-3">
                <label class="filter-label">Email</label>
                <input type="email" class="form-control-custom" id="searchEmail" placeholder="Search by email..." onkeyup="optimizedSearch()">
              </div>
              <div class="col-md-3">
                <label class="filter-label">Status</label>
                <select class="form-control-custom" id="filterStatus" onchange="applyFilters()">
                  <option value="">All Status</option>
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                  <option value="Opt-Out">Opt-Out</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="filter-label">Branch</label>
                <select class="form-control-custom" id="filterBranch" onchange="applyFilters()">
                  <option value="">All Branches</option>
                  <option value="Hamdan">Hamdan</option>
                  <option value="Muroor">Muroor</option>
                  <option value="Shabiya 11">Shabiya 11</option>
                  <option value="Al Barsha">Al Barsha</option>
                  <option value="Al Rigga">Al Rigga</option>
                  <option value="Khalidiya">Khalidiya</option>
                  <option value="Al Satwa">Al Satwa</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="filter-label">Lifecycle Stage</label>
                <select class="form-control-custom" id="filterLifecycle" onchange="applyFilters()">
                  <option value="">All Stages</option>
                  <option value="LEAD">Lead</option>
                  <option value="PROSPECT">Prospect</option>
                  <option value="ACTIVE">Active</option>
                  <option value="CHURNED">Churned</option>
                  <option value="REACTIVATED">Reactivated</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="filter-label">Tags</label>
                <select class="form-control-custom" id="filterTags" onchange="applyFilters()">
                  <option value="">All Tags</option>
                  <option value="VIP">VIP</option>
                  <option value="Premium">Premium</option>
                  <option value="New">New</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="filter-label">Date Added</label>
                <input type="date" class="form-control-custom" id="filterDate" onchange="applyFilters()">
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Segmentation Tool -->
        <div class="content-card">
          <h5 class="mb-3">Advanced Customer Segmentation</h5>
          <div class="segmentation-tool">
            <div class="row">
              <div class="col-md-6">
                <div class="form-floating-custom">
                  <label class="filter-label">Segment Name</label>
                  <input type="text" class="form-control-custom" id="segmentName" placeholder="Enter segment name">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="dynamicSegment">
                  <label class="form-check-label" for="dynamicSegment">
                    Dynamic Segment (auto-updates)
                  </label>
                </div>
              </div>
            </div>
            
            <div id="segmentBuilder" class="mt-3">
              <div class="rule-builder">
                <div class="rule-container">
                  <select class="rule-field form-control-custom">
                    <option value="">Select Field</option>
                    <option value="firstName">First Name</option>
                    <option value="lastName">Last Name</option>
                    <option value="phone">Phone</option>
                    <option value="email">Email</option>
                    <option value="branch">Branch</option>
                    <option value="status">Status</option>
                    <option value="lifecycleStage">Lifecycle Stage</option>
                    <option value="addedDate">Added Date</option>
                    <option value="lastContact">Last Contact</option>
                  </select>
                  <select class="rule-operator form-control-custom">
                    <option value="equals">Equals</option>
                    <option value="not_equals">Not Equals</option>
                    <option value="contains">Contains</option>
                    <option value="not_contains">Not Contains</option>
                    <option value="greater_than">Greater Than</option>
                    <option value="less_than">Less Than</option>
                    <option value="before">Before</option>
                    <option value="after">After</option>
                  </select>
                  <input type="text" class="rule-value form-control-custom" placeholder="Value">
                  <button type="button" class="btn btn-danger" onclick="removeRule(this)">Remove</button>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addRule()">Add Rule</button>
              </div>
            </div>
            
            <button class="btn btn-gradient mt-3" onclick="createAdvancedSegment()">
              <i class="bi bi-layers me-2" aria-hidden="true"></i>Create Segment
            </button>
          </div>
        </div>
        
        <!-- Segments List -->
        <div class="content-card">
          <h5 class="mb-3">Saved Segments</h5>
          <div id="segmentList">
            <!-- Segments will be dynamically added here -->
          </div>
        </div>
      </div>

      <!-- Customers Table with Virtual Scroll -->
      <div class="content-card">
        <div class="card-header-custom">
          <h3 class="mb-0">Customer List</h3>
          <div>
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" aria-label="Select all customers">
            <label for="selectAll">Select All</label>
          </div>
          <div>
            <button class="btn btn-gradient me-2" onclick="bulkActions()">
              <i class="bi bi-send me-2" aria-hidden="true"></i>Bulk Actions
            </button>
          </div>
        </div>
        
        <div class="virtual-scroll-container" id="virtualScrollContainer">
          <div class="virtual-scroll-content" id="virtualScrollContent">
            <table class="data-table" role="table" aria-label="Customer list">
              <thead>
                <tr role="row">
                  <th scope="col">
                    <input type="checkbox" id="headerCheckbox" onchange="toggleSelectAll()" aria-label="Select all customers">
                  </th>
                  <th scope="col" onclick="sortTable('name')">Name <i class="bi bi-arrow-down-up" aria-hidden="true"></i></th>
                  <th scope="col" onclick="sortTable('phone')">Phone <i class="bi bi-arrow-down-up" aria-hidden="true"></i></th>
                  <th scope="col" onclick="sortTable('email')">Email <i class="bi bi-arrow-down-up" aria-hidden="true"></i></th>
                  <th scope="col" onclick="sortTable('branch')">Branch <i class="bi bi-arrow-down-up" aria-hidden="true"></i></th>
                  <th scope="col" onclick="sortTable('status')">Status <i class="bi bi-arrow-down-up" aria-hidden="true"></i></th>
                  <th scope="col">Lifecycle</th>
                  <th scope="col">Tags</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody id="customersTableBody" role="rowgroup">
                <!-- Table rows will be dynamically added here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
          <i class="bi bi-people" aria-hidden="true"></i>
          <h4>No Customers Found</h4>
          <p>Start by adding your first customer or import existing data.</p>
          <button class="btn btn-gradient" onclick="showSection('add-customer')">
            <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>Add First Customer
          </button>
        </div>
        
        <!-- Pagination -->
        <div class="pagination-container" role="navigation" aria-label="Pagination">
          <button class="pagination-btn" onclick="changePage('first')" id="firstPageBtn" aria-label="First page">
            <i class="bi bi-chevron-double-left" aria-hidden="true"></i>
          </button>
          <button class="pagination-btn" onclick="changePage('prev')" id="prevPageBtn" aria-label="Previous page">
            <i class="bi-chevron-left" aria-hidden="true"></i>
          </button>
          <span id="pageInfo" aria-live="polite">Page 1 of 1</span>
          <button class="pagination-btn" onclick="changePage('next')" id="nextPageBtn" aria-label="Next page">
            <i class="bi-chevron-right" aria-hidden="true"></i>
          </button>
          <button class="pagination-btn" onclick="changePage('last')" id="lastPageBtn" aria-label="Last page">
            <i class="bi bi-chevron-double-right" aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </section>

    <!-- Add Customer Section -->
    <section id="add-customer-section" class="section" style="display: none;" aria-labelledby="add-customer-heading">
      <h2 id="add-customer-heading" class="sr-only">Add Customer</h2>
      
      <div class="content-card">
        <h3 class="mb-4">Add New Customer</h3>
        <form id="addCustomerForm" novalidate>
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="form-label" for="firstName">First Name *</label>
                <input type="text" class="form-control-custom" id="firstName" required aria-required="true">
                <div class="invalid-feedback">Please provide a first name.</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="form-label" for="lastName">Last Name</label>
                <input type="text" class="form-control-custom" id="lastName">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="form-label" for="phoneNumber">Phone Number *</label>
                <input type="tel" class="form-control-custom" id="phoneNumber" required aria-required="true">
                <div class="invalid-feedback">Please enter a valid phone number.</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="form-label" for="email">Email</label>
                <input type="email" class="form-control-custom" id="email">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="form-label" for="branch">Branch *</label>
                <select class="form-control-custom" id="branch" required aria-required="true">
                  <option value="">Select Branch</option>
                  <option value="Hamdan">Hamdan</option>
                  <option value="Muroor">Muroor</option>
                  <option value="Shabiya 11">Shabiya 11</option>
                  <option value="Al Barsha">Al Barsha</option>
                  <option value="Al Rigga">Al Rigga</option>
                  <option value="Khalidiya">Khalidiya</option>
                  <option value="Al Satwa">Al Satwa</option>
                </select>
                <div class="invalid-feedback">Please select a branch.</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="form-label" for="status">Status</label>
                <select class="form-control-custom" id="status">
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="form-label" for="lifecycleStage">Lifecycle Stage</label>
                <select class="form-control-custom" id="lifecycleStage">
                  <option value="LEAD">Lead</option>
                  <option value="PROSPECT">Prospect</option>
                  <option value="ACTIVE">Active</option>
                  <option value="CHURNED">Churned</option>
                  <option value="REACTIVATED">Reactivated</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="form-label" for="tags">Tags (comma separated)</label>
                <input type="text" class="form-control-custom" id="tags" placeholder="VIP, Premium, New">
              </div>
            </div>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-gradient">
              <i class="bi bi-save me-2" aria-hidden="true"></i>Save Customer
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
              <i class="bi bi-arrow-clockwise me-2" aria-hidden="true"></i>Reset
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- Customer Detail Modal -->
    <div class="modal fade" id="customerDetailModal" tabindex="-1" aria-labelledby="customerDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="customerDetailModalLabel">Customer Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
              <i class="bi bi-x-lg" aria-hidden="true"></i>
            </button>
          </div>
          <div class="modal-body">
            <!-- Customer details will be dynamically added here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Messaging Section -->
    <section id="messaging-section" class="section" style="display: none;" aria-labelledby="messaging-heading">
      <h2 id="messaging-heading" class="sr-only">Messaging</h2>
      
      <div class="content-card">
        <h3 class="mb-4">Send Messages</h3>
        
        <!-- Message Templates -->
        <div class="content-card mb-3">
          <div class="card-header-custom">
            <h5 class="mb-0">Message Templates</h5>
            <button class="btn btn-gradient btn-sm" onclick="manageMessageTemplates()">
              <i class="bi bi-gear me-2" aria-hidden="true"></i>Manage Templates
            </button>
          </div>
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">Select Template</label>
              <select class="form-control-custom" id="msgTemplate" onchange="loadTemplate()">
                <option value="">Select Template</option>
                <!-- Templates will be dynamically added here -->
              </select>
            </div>
          </div>
        </div>

        <!-- Message Type Selection -->
        <div class="row mb-4">
          <div class="col-md-12">
            <label class="form-label">Message Type</label>
            <div class="btn-group w-100" role="group" aria-label="Message type selection">
              <input type="radio" class="btn-check" name="msgType" id="msgWhatsApp" value="whatsapp" checked>
              <label class="btn btn-outline-success" for="msgWhatsApp">
                <i class="bi bi-whatsapp me-2" aria-hidden="true"></i>WhatsApp
              </label>
              <input type="radio" class="btn-check" name="msgType" id="msgSMS" value="sms">
              <label class="btn btn-outline-primary" for="msgSMS">
                <i class="bi bi-chat-dots me-2" aria-hidden="true"></i>SMS
              </label>
            </div>
          </div>
        </div>

        <!-- Recipients Selection -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label class="form-label">Select Recipients</label>
            <select class="form-control-custom" id="recipientType" onchange="updateRecipients()">
              <option value="all">All Active Customers</option>
              <option value="branch">By Branch</option>
              <option value="lifecycle">By Lifecycle Stage</option>
              <option value="tags">By Tags</option>
              <option value="selected">Selected Customers</option>
              <option value="segment">By Segment</option>
            </select>
          </div>
          <div class="col-md-6" id="branchSelection" style="display: none;">
            <label class="form-label">Select Branch</label>
            <select class="form-control-custom" id="msgBranch">
              <option value="Hamdan">Hamdan</option>
              <option value="Muroor">Muroor</option>
              <option value="Shabiya 11">Shabiya 11</option>
              <option value="Al Barsha">Al Barsha</option>
              <option value="Al Rigga">Al Rigga</option>
              <option value="Khalidiya">Khalidiya</option>
              <option value="Al Satwa">Al Satwa</option>
            </select>
          </div>
          <div class="col-md-6" id="lifecycleSelection" style="display: none;">
            <label class="form-label">Select Lifecycle Stage</label>
            <select class="form-control-custom" id="msgLifecycle">
              <option value="LEAD">Lead</option>
              <option value="PROSPECT">Prospect</option>
              <option value="ACTIVE">Active</option>
              <option value="CHURNED">Churned</option>
              <option value="REACTIVATED">Reactivated</option>
            </select>
          </div>
          <div class="col-md-6" id="tagsSelection" style="display: none;">
            <label class="form-label">Select Tags</label>
            <select class="form-control-custom" id="msgTags">
              <option value="VIP">VIP</option>
              <option value="Premium">Premium</option>
              <option value="New">New</option>
            </select>
          </div>
          <div class="col-md-6" id="segmentSelection" style="display: none;">
            <label class="form-label">Select Segment</label>
            <select class="form-control-custom" id="msgSegment">
              <!-- Segments will be dynamically added here -->
            </select>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-12">
            <label class="form-label">Message Content</label>
            <textarea class="form-control-custom" id="msgText" rows="4" placeholder="Type your message here..." aria-label="Message content"></textarea>
          </div>
        </div>

        <!-- Schedule Option -->
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="scheduleMessage" onchange="toggleSchedule()">
              <label class="form-check-label" for="scheduleMessage">Schedule for later</label>
            </div>
            <div class="col-md-6" id="scheduleOptions" style="display: none;">
              <label class="form-label">Schedule for</label>
              <input type="datetime-local" class="form-control-custom" id="scheduleDateTime">
            </div>
          </div>
        </div>

        <!-- Recipients Preview -->
        <div class="mb-4">
          <label class="form-label">Recipients (<span id="recipientCount">0</span>)</label>
          <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;" role="region" aria-label="Recipients list">
            <div id="recipientsList"></div>
          </div>
        </div>

        <!-- Send Button -->
        <button class="btn btn-success-gradient btn-lg" onclick="sendMessagesOptimized()" aria-label="Send messages">
          <i class="bi bi-send-fill me-2" aria-hidden="true"></i>Send Messages
        </button>

        <!-- Message Progress -->
        <div class="message-progress" id="messageProgress">
          <h4 class="mb-3">Sending Progress</h4>
          <div id="progressList" role="log" aria-live="polite"></div>
        </div>

        <!-- WhatsApp Links -->
        <div class="whatsapp-links" id="whatsappLinks">
          <h4 class="mb-3">WhatsApp Links</h4>
          <p class="text-muted">Click on any link to open WhatsApp with pre-filled message</p>
          <div id="whatsappLinksList"></div>
        </div>
      </div>
    </section>

    <!-- Follow-ups Section -->
    <section id="followups-section" class="section" style="display: none;" aria-labelledby="followups-heading">
      <h2 id="followups-heading" class="sr-only">Follow-ups</h2>
      
      <div class="content-card">
        <div class="card-header-custom">
          <h3 class="mb-0">Follow-up Reminders</h3>
          <button class="btn btn-gradient" onclick="showAddFollowupModal()">
            <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>Add Follow-up
          </button>
        </div>
        
        <div class="followups-list" id="followupsList">
          <!-- Follow-ups will be dynamically added here -->
        </div>
      </div>
    </section>

    <!-- Tasks Section -->
    <section id="tasks-section" class="section" style="display: none;" aria-labelledby="tasks-heading">
      <h2 id="tasks-heading" class="sr-only">Tasks</h2>
      
      <div class="content-card">
        <div class="card-header-custom">
          <h3 class="mb-0">Task Management</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-gradient" onclick="createTask()">
              <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>Create Task
            </button>
            <button class="btn btn-outline-light" onclick="filterTasks()">
              <i class="bi bi-funnel-fill me-2" aria-hidden="true"></i>Filter Tasks
            </button>
          </div>
        </div>
        
        <div class="task-list" id="taskList">
          <!-- Tasks will be dynamically added here -->
        </div>
      </div>
    </section>

    <!-- Analytics Section -->
    <section id="analytics-section" class="section" style="display: none;" aria-labelledby="analytics-heading">
      <h2 id="analytics-heading" class="sr-only">Analytics</h2>
      
      <div class="row">
        <div class="col-md-6">
          <h4 class="mb-3">Customer Growth</h4>
          <div class="chart-container">
            <canvas id="customerGrowthChart" role="img" aria-label="Customer growth chart"></canvas>
          </div>
        </div>
        <div class="col-md-6">
          <h4 class="mb-3">Branch Distribution</h4>
          <div class="chart-container">
            <canvas id="branchDistributionChart" role="img" aria-label="Branch distribution chart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-6">
          <h4 class="mb-3">Message Statistics</h4>
          <div class="chart-container">
            <canvas id="messageStatsChart" role="img" aria-label="Message statistics chart"></canvas>
          </div>
        </div>
        <div class="col-md-6">
          <h4 class="mb-3">Customer Status</h4>
          <div class="chart-container">
            <canvas id="statusChart" role="img" aria-label="Customer status chart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-6">
          <h4 class="mb-3">Customer Lifecycle</h4>
          <div class="chart-container">
            <canvas id="lifecycleChart" role="img" aria-label="Customer lifecycle chart"></canvas>
          </div>
        </div>
        <div class="col-md-6">
          <h4 class="mb-3">Retention Analysis</h4>
          <div class="chart-container">
            <canvas id="retentionChart" role="img" aria-label="Retention analysis chart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Portal Section -->
    <section id="portal-section" class="section" style="display: none;" aria-labelledby="portal-heading">
      <h2 id="portal-heading" class="sr-only">Customer Portal</h2>
      
      <div class="content-card">
        <h3 class="mb-4">Customer Portal Settings</h3>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" id="enablePortal" checked>
              <label class="form-check-label" for="enablePortal">Enable Customer Portal</label>
            </div>
            <p class="text-muted">Allow customers to view their information and update preferences</p>
          </div>
          <div class="col-md-6">
            <h5>Portal URL</h5>
            <div class="form-floating-custom">
              <label class="form-label">Portal URL</label>
              <input type="url" class="form-control-custom" id="portalUrl" value="https://yourcompany.com/portal">
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <h5>Custom Fields</h5>
            <div class="form-check">
              <input class="form-check-input" id="allowProfileEdit" checked>
              <label class="form-check-label" for="allowProfileEdit">Allow Profile Editing</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" id="allowCommunicationPrefs" checked>
              <label class="form-check-label" for="allowCommunicationPrefs">Communication Preferences</label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Settings Section -->
    <section id="settings-section" class="section" style="display: none;" aria-labelledby="settings-heading">
      <h2 id="settings-heading" class="sr-only">Settings</h2>
      
      <div class="row">
        <div class="col-md-6">
          <h5>General Settings</h5>
          <div class="form-floating-custom">
            <label class="form-label">Company Name</label>
            <input type="text" class="form-control-custom" id="companyName" value="Your Company">
          </div>
          <div class="form-floating-custom">
            <label class="form-label">Company Phone</label>
            <input type="tel" class="form-control-custom" id="companyPhone" value="+971501882206">
          </div>
        </div>
        <div class="col-md-6">
          <h5>Display Settings</h5>
          <div class="form-floating-custom">
            <label class="form-label">Items per page</label>
            <select class="form-control-custom" id="pageSize">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-6">
          <h5>Security Settings</h5>
          <div class="form-check">
            <input class="form-check-input" id="twoFactorAuth">
            <label class="form-check-label" for="twoFactorAuth">Two-Factor Authentication</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" id="dataEncryption" checked>
            <label class="form-check-label" for="dataEncryption">Data Encryption</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" id="auditLog" checked>
            <label class="form-check-label" for="auditLog">Activity Logging</label>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-12">
          <h5>Data Management</h5>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-gradient" onclick="showExportModal()">
              <i class="bi bi-download me-2" aria-hidden="true"></i>Export All Data
            </button>
            <button class="btn btn-success-gradient" onclick="backupData()">
              <i class="bi bi-cloud-download me-2" aria-hidden="true"></i>Backup
            </button>
            <button class="btn btn-danger-gradient" onclick="clearAllData()">
              <i class="bi bi-trash me-2" aria-hidden="true"></i>Clear All
            </button>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-6">
          <h5>WhatsApp Integration</h5>
          <div class="form-floating-custom">
            <label class="form-label">WhatsApp Business Number</label>
            <input type="tel" class="form-control-custom" id="whatsappNumber" value="+971501882206">
          </div>
        </div>
        <div class="col-md-6">
          <h5>Email Integration</h5>
          <div class="form-floating-custom">
            <label class="form-label">SMTP Server</label>
            <input type="text" class="form-control-custom" id="smtpServer" value="smtp.gmail.com">
          </div>
        </div>
      </div>
    </section>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exportModalLabel">Export Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
              <i class="bi bi-x-lg" aria-hidden="true"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="export-options">
              <h6>Select Export Format</h6>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="exportFormat" id="exportCSV" value="csv" checked>
                <label class="form-check-label" for="exportCSV">CSV</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="exportFormat" id="exportJSON" value="json">
                <label class="form-check-label" for="exportJSON">JSON</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="exportFormat" id="exportExcel" value="excel">
                <label class="form-check-label" for="exportExcel">Excel</label>
              </div>
            </div>
            
            <div class="export-options">
              <h6>Select Fields to Export</h6>
              <div class="row">
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input export-field" type="checkbox" value="firstName" checked>
                    <label class="form-check-label">First Name</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input export-field" type="checkbox" value="lastName" checked>
                    <label class="form-check-label">Last Name</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input export-field" type="checkbox" value="phone" checked>
                    <label class="form-check-label">Phone</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input export-field" type="checkbox" value="email" checked>
                    <label class="form-check-label">Email</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input export-field" type="checkbox" value="branch" checked>
                    <label class="form-check-label">Branch</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input export-field" type="checkbox" value="status" checked>
                    <label class="form-check-label">Status</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input export-field" type="checkbox" value="lifecycleStage">
                    <label class="form-check-label">Lifecycle Stage</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input export-field" type="checkbox" value="addedDate">
                    <label class="form-check-label">Added Date</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input export-field" type="checkbox" value="tags">
                    <label class="form-check-label">Tags</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-gradient" onclick="exportDataEnhanced()">
              <i class="bi bi-download me-2" aria-hidden="true"></i>Export Data
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Template Modal -->
    <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="templateModalLabel">Message Templates</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
              <i class="bi bi-x-lg" aria-hidden="true"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="template-manager" id="templateManager">
              <!-- Templates will be dynamically added here -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-gradient" onclick="showAddTemplateForm()">
              <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>Add Template
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="importModalLabel">Import Customers</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
              <i class="bi bi-x-lg" aria-hidden="true"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <div class="file-input-wrapper">
                <input type="file" id="importFile" accept=".csv">
                <label for="importFile" class="file-input-label">
                  <i class="bi bi-cloud-upload"></i>
                  Import CSV File
                </label>
              </div>
            </div>
            <div id="importPreview" style="display: none;">
              <h6>Import Preview</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>First Name</th>
                      <th>Last Name</th>
                      <th>Phone</th>
                      <th>Email</th>
                      <th>Branch</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="importPreviewBody">
                    <!-- Preview rows will be dynamically added -->
                  </tbody>
                </table>
              </div>
              <div class="mt-3">
                <button class="btn btn-gradient" onclick="confirmImport()">
                  <i class="bi bi-check-circle me-2" aria-hidden="true"></i>Import Data
                </button>
                <button class="btn btn-secondary" onclick="closeImportModal()">
                  <i class="bi bi-x-circle me-2" aria-hidden="true"></i>Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Follow-up Modal -->
    <div class="modal fade" id="addFollowupModal" tabindex="-1" aria-labelledby="addFollowupModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addFollowupModalLabel">Add Follow-up</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
              <i class="bi bi-x-lg" aria-hidden="true"></i>
            </button>
          </div>
          <div class="modal-body">
            <form id="addFollowupForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-floating-custom">
                    <label class="form-label">Customer</label>
                    <select class="form-control-custom" id="followupCustomer" required>
                      <option value="">Select Customer</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating-custom">
                    <label class="form-label">Follow-up Type</label>
                    <select class="form-control-custom" id="followupType" required>
                      <option value="call">Phone Call</option>
                      <option value="email">Email</option>
                      <option value="meeting">Meeting</option>
                      <option value="sms">SMS</option>
                      <option value="whatsapp">WhatsApp</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-6">
                  <div class="form-floating-custom">
                    <label class="form-label">Due Date</label>
                    <input type="datetime-local" class="form-control-custom" id="followupDate" required>
                  </div>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-12">
                  <div class="form-floating-custom">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control-custom" id="followupNotes" rows="3"></textarea>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-gradient" onclick="addFollowup()">
              <i class="bi bi-calendar-plus me-2" aria-hidden="true"></i>Add Follow-up
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Voice Command Indicator -->
    <div class="voice-indicator" id="voiceIndicator" style="display: none;" aria-live="polite">
      <i class="bi bi-mic" aria-hidden="true"></i>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
      <i class="bi bi-moon-stars-fill" id="themeIcon" aria-hidden="true"></i>
    </button>

    <!-- Toast Container -->
    <div class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" role="dialog" aria-modal="true" aria-label="Loading">
      <div class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Processing...</p>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Application State
    let customers = [];
    let messageLog = [];
    let followups = [];
    let activityFeed = [];
    let settings = {
      companyName: 'Your Company',
      companyPhone: '+971501882206',
      pageSize: 10,
      theme: 'light'
    };
    let selectedCustomers = new Set();
    let currentSection = 'dashboard';
    let sortColumn = 'addedDate';
    let sortDirection = 'desc';
    let currentPage = 1;
    let charts = {};
    let segments = [];
    let tasks = [];
    let notifications = [];
    let messageTemplates = [];
    let searchTimeout;
    let virtualScrollConfig = {
      itemHeight: 60,
      containerHeight: 500,
      buffer: 5
    };
    
    // Initialize Application
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      debug('Initializing application...');
      initializeTheme();
      loadData();
      loadMessageTemplates();
      showSection('dashboard');
      updateMetrics();
      renderCustomers();
      renderFollowups();
      renderTasks();
      renderActivityFeed();
      checkFollowupReminders();
      initializeCharts();
      setupPWAIntegration();
      setupVoiceCommands();
      setupAutoSave();
      setupVirtualScroll();
      setupSearchSuggestions();
      debug('Application initialized');
    }

    // Initialize Theme
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
    }

    // Toggle Theme
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
      
      showToast(`Theme changed to ${newTheme}`, 'success');
    }

    // Update Theme Icon
    function updateThemeIcon(theme) {
      const icon = document.getElementById('themeIcon');
      if (icon) {
        icon.className = theme === 'light' ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill';
      }
    }

    // Load Data
    function loadData() {
      debug('Loading data...');
      
      try {
        const storedCustomers = localStorage.getItem('customers');
        const storedMessageLog = localStorage.getItem('messageLog');
        const storedFollowups = localStorage.getItem('followups');
        const storedActivityFeed = localStorage.getItem('activityFeed');
        const storedSettings = localStorage.getItem('settings');
        const storedSegments = localStorage.getItem('segments');
        const storedTasks = localStorage.getItem('tasks');
        
        if (storedCustomers) {
          customers = JSON.parse(storedCustomers);
          debug(`Loaded ${customers.length} customers from storage`);
        } else {
          debug('No customers found in storage, initializing...');
          initializeSampleData();
        }
        
        if (storedMessageLog) {
          messageLog = JSON.parse(storedMessageLog);
          debug(`Loaded ${messageLog.length} message logs from storage`);
        }
        
        if (storedFollowups) {
          followups = JSON.parse(storedFollowups);
          debug(`Loaded ${followups.length} followups from storage`);
        }
        
        if (storedActivityFeed) {
          activityFeed = JSON.parse(storedActivityFeed);
          debug(`Loaded ${activityFeed.length} activity items from storage`);
        }
        
        if (storedSettings) {
          settings = JSON.parse(storedSettings);
          debug('Settings loaded from storage');
        }
        
        if (storedSegments) {
          segments = JSON.parse(storedSegments);
          debug(`Loaded ${segments.length} segments from storage`);
        }
        
        if (storedTasks) {
          tasks = JSON.parse(storedTasks);
          debug(`Loaded ${tasks.length} tasks from storage`);
        }
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading data. Please refresh the page.', 'error');
      }
    }

    // Initialize Sample Data
    function initializeSampleData() {
      debug('Initializing sample data...');
      
      const sampleData = [
        { branch: 'Hamdan', mobile: '564394125', name: 'CHRISTINE JOY' },
        { branch: 'Muroor', mobile: '527186938', name: 'REN ALVAREZ', email: 'ren@email.com' },
        { branch: 'Shabiya 11', mobile: '501320863', name: 'FARDUS KHAN', email: 'fardus@email.com' },
        { branch: 'Shabiya 11', mobile: '504007898', name: 'JUMANA SAEED', email: 'jumana@email.com' },
        { branch: 'Al Barsha', mobile: '567578678', name: 'ROSE WILSON', email: 'rose@email.com' },
        { branch: 'Al Rigga', mobile: '569307444', name: 'ROSE WILSON', email: 'rose@email.com' },
        { branch: 'Hamdan', mobile: '501989046', name: 'MUSTAFA', email: 'mustafa@gmail.com' },
        { branch: 'Hamdan', mobile: '5059307444', name: 'MUSTAFA', email: 'mustafa@gmail.com' }
      ];
      
      customers = sampleData.map((item, index) => {
        const date = new Date();
        date.setMonth(date.getMonth() - Math.floor(Math.random() * 6));
        date.setDate(date.getDate() - Math.floor(Math.random() * 30));
        
        const nameParts = item.name.split(' ');
        const firstName = nameParts[0];
        const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';
        
        return {
          id: Date.now() + index,
          firstName,
          lastName,
          phone: `+971${item.mobile}`,
          email: item.email || '',
          branch: item.branch,
          status: 'Active',
          lifecycleStage: ['LEAD', 'PROSPECT', 'ACTIVE'][Math.floor(Math.random() * 3)],
          addedDate: date.toISOString(),
          lastContact: date.toISOString(),
          lastMessageDate: null,
          tags: Math.random() > 0.7 ? ['VIP', 'Premium', 'New'][Math.floor(Math.random() * 3)] : []
        };
      });
      
      saveData();
      debug(`Created ${customers.length} sample customers`);
    }

    // Save Data
    function saveData() {
      try {
        localStorage.setItem('customers', JSON.stringify(customers));
        localStorage.setItem('messageLog', JSON.stringify(messageLog));
        localStorage.setItem('followups', JSON.stringify(followups));
        localStorage.setItem('activityFeed', JSON.stringify(activityFeed));
        localStorage.setItem('settings', JSON.stringify(settings));
        localStorage.setItem('segments', JSON.stringify(segments));
        localStorage.setItem('tasks', JSON.stringify(tasks));
        debug('Data saved to localStorage');
      } catch (error) {
        console.error('Error saving data:', error);
        showToast('Error saving data. Some changes may be lost.', 'error');
      }
    }

    // Update Metrics
    function updateMetrics() {
      const total = customers.length;
      const active = customers.filter(c => c.status === 'Active').length;
      const now = new Date();
      const thisMonth = customers.filter(c => {
        const addedDate = new Date(c.addedDate);
        return addedDate.getMonth() === now.getMonth() && addedDate.getFullYear() === now.getFullYear();
      }).length;
      
      updateElement('totalCustomers', total);
      updateElement('activeCustomers', active);
      updateElement('newThisMonth', thisMonth);
      updateElement('messagesSent', messageLog.length);
      updateElement('followupCount', followups.filter(f => f.status === 'pending').length);
      updateElement('retentionRate', `${calculateRetentionRate()}%`);
      
      debug('Metrics updated');
    }

    // Calculate Retention Rate
    function calculateRetentionRate() {
      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
      const oldCustomers = customers.filter(c => new Date(c.addedDate) < thirtyDaysAgo);
      const activeOldCustomers = oldCustomers.filter(c => c.status === 'Active');
      
      if (oldCustomers.length === 0) return 100;
      return Math.round((activeOldCustomers.length / oldCustomers.length) * 100);
    }

    // Show Section
    function showSection(section) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(s => {
        s.style.display = 'none';
      });
      
      // Show selected section
      const sectionElement = document.getElementById(`${section}-section`);
      if (sectionElement) {
        sectionElement.style.display = 'block';
      }
      
      // Update sidebar active state
      document.querySelectorAll('.sidebar-menu a').forEach(a => {
        a.classList.remove('active');
        a.removeAttribute('aria-current');
      });
      
      const activeLink = document.querySelector(`.sidebar-menu a[onclick="showSection('${section}')"]`);
      if (activeLink) {
        activeLink.classList.add('active');
        activeLink.setAttribute('aria-current', 'page');
      }
      
      currentSection = section;
      
      // Section-specific initialization
      if (section === 'customers') {
        renderCustomers();
        renderSegments();
        updateSegmentDropdown();
      } else if (section === 'analytics') {
        if (Object.keys(charts).length === 0) {
          initializeCharts();
        }
        updateCharts();
      } else if (section === 'tasks') {
        renderTasks();
      } else if (section === 'followups') {
        renderFollowups();
      } else if (section === 'messaging') {
        updateTemplateDropdown();
        updateSegmentDropdown();
      }
    }

    // Toggle Sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      
      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('expanded');
    }

    // Setup Virtual Scroll
    function setupVirtualScroll() {
      const container = document.getElementById('virtualScrollContainer');
      if (!container) return;
      
      container.addEventListener('scroll', function() {
        renderCustomers();
      });
    }

    // Render Customers Table with Virtual Scroll
    function renderCustomers() {
      const tbody = document.getElementById('customersTableBody');
      const emptyState = document.getElementById('emptyState');
      const container = document.getElementById('virtualScrollContainer');
      
      if (!tbody) return;
      
      let filtered = [...customers];
      
      // Apply filters
      const filters = {
        name: document.getElementById('searchName')?.value?.toLowerCase() || '',
        phone: document.getElementById('searchPhone')?.value || '',
        email: document.getElementById('searchEmail')?.value?.toLowerCase() || '',
        status: document.getElementById('filterStatus')?.value || '',
        branch: document.getElementById('filterBranch')?.value || '',
        lifecycle: document.getElementById('filterLifecycle')?.value || '',
        tags: document.getElementById('filterTags')?.value || '',
        date: document.getElementById('filterDate')?.value || ''
      };
      
      filtered = filtered.filter(customer => {
        if (filters.name && !(`${customer.firstName} ${customer.lastName || ''}`.toLowerCase().includes(filters.name))) return false;
        if (filters.phone && !customer.phone.includes(filters.phone)) return false;
        if (filters.email && customer.email && !customer.email.toLowerCase().includes(filters.email)) return false;
        if (filters.status && customer.status !== filters.status) return false;
        if (filters.branch && customer.branch !== filters.branch) return false;
        if (filters.lifecycle && customer.lifecycleStage !== filters.lifecycle) return false;
        if (filters.tags && (!customer.tags || !customer.tags.includes(filters.tags))) return false;
        if (filters.date) {
          const filterDate = new Date(filters.date);
          const addedDate = new Date(customer.addedDate);
          return addedDate <= filterDate;
        }
        return true;
      });
      
      // Sort
      filtered.sort((a, b) => {
        let aVal = a[sortColumn] || '';
        let bVal = b[sortColumn] || '';
        
        if (sortColumn === 'name') {
          aVal = `${a.firstName} ${a.lastName || ''}`.toLowerCase();
          bVal = `${b.firstName} ${b.lastName || ''}`.toLowerCase();
        }
        
        if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      
      // Virtual scroll implementation
      if (container && filtered.length > 50) {
        renderVirtualScroll(filtered, tbody);
      } else {
        renderStandardTable(filtered, tbody);
      }
      
      // Update empty state
      if (filtered.length === 0) {
        if (container) container.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
      } else {
        if (container) container.style.display = 'block';
        if (emptyState) emptyState.style.display = 'none';
      }
      
      // Update pagination
      updatePagination(filtered.length);
    }

    // Render Virtual Scroll
    function renderVirtualScroll(data, tbody) {
      const container = document.getElementById('virtualScrollContainer');
      const scrollTop = container.scrollTop;
      const itemHeight = virtualScrollConfig.itemHeight;
      const containerHeight = virtualScrollConfig.containerHeight;
      const buffer = virtualScrollConfig.buffer;
      
      const startIndex = Math.max(0, Math.floor(scrollTop / itemHeight) - buffer);
      const endIndex = Math.min(data.length, startIndex + Math.ceil(containerHeight / itemHeight) + buffer * 2);
      
      // Clear tbody
      tbody.innerHTML = '';
      
      // Add top spacer
      const topSpacer = document.createElement('tr');
      topSpacer.style.height = `${startIndex * itemHeight}px`;
      topSpacer.innerHTML = '<td colspan="9"></td>';
      tbody.appendChild(topSpacer);
      
      // Render visible items
      for (let i = startIndex; i < endIndex; i++) {
        const customer = data[i];
        const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>
            <input type="checkbox" class="customer-checkbox" data-id="${customer.id}" onchange="toggleCustomerSelection('${customer.id}')" aria-label="Select customer">
          </td>
          <td>${fullName}</td>
          <td>${customer.phone}</td>
          <td>${customer.email || '-'}</td>
          <td>${customer.branch}</td>
          <td>
            <span class="status-badge status-${customer.status.toLowerCase()}">${customer.status}</span>
          </td>
          <td>
            <span class="lifecycle-stage stage-${customer.lifecycleStage.toLowerCase()}">${customer.lifecycleStage}</span>
          </td>
          <td>
            <div class="customer-tags">
              ${(customer.tags || []).map(tag => `<span class="tag ${tag.toLowerCase()}">${tag}</span>`).join('')}
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-action btn-success" onclick="quickMessage('${customer.id}')" title="Send Message" aria-label="Send message to ${fullName}">
                <i class="bi bi-send"></i>
              </button>
              <button class="btn-action btn-primary" onclick="viewCustomer('${customer.id}')" title="View Details" aria-label="View details for ${fullName}">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn-action btn-warning" onclick="editCustomer('${customer.id}')" title="Edit" aria-label="Edit ${fullName}">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn-action btn-danger" onclick="deleteCustomer('${customer.id}')" title="Delete" aria-label="Delete ${fullName}">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(tr);
      }
      
      // Add bottom spacer
      const bottomSpacer = document.createElement('tr');
      bottomSpacer.style.height = `${(data.length - endIndex) * itemHeight}px`;
      bottomSpacer.innerHTML = '<td colspan="9"></td>';
      tbody.appendChild(bottomSpacer);
      
      // Update container height
      const content = document.getElementById('virtualScrollContent');
      if (content) {
        content.style.height = `${data.length * itemHeight}px`;
      }
    }

    // Render Standard Table
    function renderStandardTable(data, tbody) {
      // Pagination
      const pageSize = parseInt(settings.pageSize) || 10;
      const totalPages = Math.ceil(data.length / pageSize);
      currentPage = Math.min(currentPage, totalPages || 1);
      
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const paginatedData = data.slice(startIndex, endIndex);
      
      // Clear tbody
      tbody.innerHTML = '';
      
      // Render rows
      paginatedData.forEach(customer => {
        const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>
            <input type="checkbox" class="customer-checkbox" data-id="${customer.id}" onchange="toggleCustomerSelection('${customer.id}')" aria-label="Select customer">
          </td>
          <td>${fullName}</td>
          <td>${customer.phone}</td>
          <td>${customer.email || '-'}</td>
          <td>${customer.branch}</td>
          <td>
            <span class="status-badge status-${customer.status.toLowerCase()}">${customer.status}</span>
          </td>
          <td>
            <span class="lifecycle-stage stage-${customer.lifecycleStage.toLowerCase()}">${customer.lifecycleStage}</span>
          </td>
          <td>
            <div class="customer-tags">
              ${(customer.tags || []).map(tag => `<span class="tag ${tag.toLowerCase()}">${tag}</span>`).join('')}
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-action btn-success" onclick="quickMessage('${customer.id}')" title="Send Message" aria-label="Send message to ${fullName}">
                <i class="bi bi-send"></i>
              </button>
              <button class="btn-action btn-primary" onclick="viewCustomer('${customer.id}')" title="View Details" aria-label="View details for ${fullName}">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn-action btn-warning" onclick="editCustomer('${customer.id}')" title="Edit" aria-label="Edit ${fullName}">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn-action btn-danger" onclick="deleteCustomer('${customer.id}')" title="Delete" aria-label="Delete ${fullName}">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // Update Pagination
    function updatePagination(totalItems) {
      const pageInfo = document.getElementById('pageInfo');
      const firstBtn = document.getElementById('firstPageBtn');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      const lastBtn = document.getElementById('lastPageBtn');
      
      const pageSize = parseInt(settings.pageSize) || 10;
      const totalPages = Math.ceil(totalItems / pageSize);
      
      if (pageInfo) {
        pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1} (${totalItems} items)`;
      }
      
      if (firstBtn) firstBtn.disabled = currentPage <= 1;
      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
      if (lastBtn) lastBtn.disabled = currentPage >= totalPages;
    }

    // Change Page
    function changePage(direction) {
      const tbody = document.getElementById('customersTableBody');
      if (!tbody) return;
      
      let filtered = [...customers];
      
      // Apply filters
      const filters = {
        name: document.getElementById('searchName')?.value?.toLowerCase() || '',
        phone: document.getElementById('searchPhone')?.value || '',
        email: document.getElementById('searchEmail')?.value?.toLowerCase() || '',
        status: document.getElementById('filterStatus')?.value || '',
        branch: document.getElementById('filterBranch')?.value || '',
        lifecycle: document.getElementById('filterLifecycle')?.value || '',
        tags: document.getElementById('filterTags')?.value || '',
        date: document.getElementById('filterDate')?.value || ''
      };
      
      filtered = filtered.filter(customer => {
        if (filters.name && !(`${customer.firstName} ${customer.lastName || ''}`.toLowerCase().includes(filters.name))) return false;
        if (filters.phone && !customer.phone.includes(filters.phone)) return false;
        if (filters.email && customer.email && !customer.email.toLowerCase().includes(filters.email)) return false;
        if (filters.status && customer.status !== filters.status) return false;
        if (filters.branch && customer.branch !== filters.branch) return false;
        if (filters.lifecycle && customer.lifecycleStage !== filters.lifecycle) return false;
        if (filters.tags && (!customer.tags || !customer.tags.includes(filters.tags))) return false;
        if (filters.date) {
          const filterDate = new Date(filters.date);
          const addedDate = new Date(customer.addedDate);
          return addedDate <= filterDate;
        }
        return true;
      });
      
      const pageSize = parseInt(settings.pageSize) || 10;
      const totalPages = Math.ceil(filtered.length / pageSize);
      
      switch (direction) {
        case 'first':
          currentPage = 1;
          break;
        case 'prev':
          currentPage = Math.max(1, currentPage - 1);
          break;
        case 'next':
          currentPage = Math.min(totalPages, currentPage + 1);
          break;
        case 'last':
          currentPage = totalPages;
          break;
      }
      
      renderCustomers();
    }

    // Sort Table
    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      renderCustomers();
    }

    // Toggle Customer Selection
    function toggleCustomerSelection(customerId) {
      if (selectedCustomers.has(customerId)) {
        selectedCustomers.delete(customerId);
      } else {
        selectedCustomers.add(customerId);
      }
      
      updateSelectAllCheckbox();
    }

    // Toggle Select All
    function toggleSelectAll() {
      const headerCheckbox = document.getElementById('headerCheckbox');
      const checkboxes = document.querySelectorAll('.customer-checkbox');
      
      if (headerCheckbox.checked) {
        checkboxes.forEach(checkbox => {
          checkbox.checked = true;
          selectedCustomers.add(checkbox.dataset.id);
        });
      } else {
        checkboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
        selectedCustomers.clear();
      }
    }

    // Update Select All Checkbox
    function updateSelectAllCheckbox() {
      const headerCheckbox = document.getElementById('headerCheckbox');
      const checkboxes = document.querySelectorAll('.customer-checkbox');
      const checkedCount = document.querySelectorAll('.customer-checkbox:checked').length;
      
      headerCheckbox.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
      headerCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }

    // Setup Search Suggestions
    function setupSearchSuggestions() {
      const searchInput = document.getElementById('searchName');
      if (!searchInput) return;
      
      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const suggestionsContainer = document.getElementById('nameSuggestions');
        
        if (query.length < 2) {
          suggestionsContainer.innerHTML = '';
          return;
        }
        
        const matches = customers
          .filter(c => `${c.firstName} ${c.lastName || ''}`.toLowerCase().includes(query))
          .slice(0, 5)
          .map(c => `${c.firstName} ${c.lastName || ''}`.trim());
        
        suggestionsContainer.innerHTML = matches.map(name => 
          `<div class="suggestion-item" onclick="selectSuggestion('${name}')">${name}</div>`
        ).join('');
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !document.getElementById('nameSuggestions').contains(e.target)) {
          document.getElementById('nameSuggestions').innerHTML = '';
        }
      });
    }

    // Select Suggestion
    function selectSuggestion(name) {
      document.getElementById('searchName').value = name;
      document.getElementById('nameSuggestions').innerHTML = '';
      applyFilters();
    }

    // Debounced Search
    function debounceSearch(func, delay) {
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => func.apply(context, args), delay);
      };
    }

    // Optimized Search
    const optimizedSearch = debounceSearch(function() {
      applyFilters();
    }, 300);

    // Apply Filters
    function applyFilters() {
      currentPage = 1;
      renderCustomers();
    }

    // View Customer
    function viewCustomer(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;
      
      const modal = new bootstrap.Modal(document.getElementById('customerDetailModal'));
      const modalBody = document.querySelector('#customerDetailModal .modal-body');
      
      const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
      
      modalBody.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h5>Personal Information</h5>
            <p><strong>Name:</strong> ${fullName}</p>
            <p><strong>Phone:</strong> ${customer.phone}</p>
            <p><strong>Email:</strong> ${customer.email || 'Not provided'}</p>
          </div>
          <div class="col-md-6">
            <h5>Account Details</h5>
            <p><strong>Branch:</strong> ${customer.branch}</p>
            <p><strong>Status:</strong> <span class="status-badge status-${customer.status.toLowerCase()}">${customer.status}</span></p>
            <p><strong>Lifecycle Stage:</strong> <span class="lifecycle-stage stage-${customer.lifecycleStage.toLowerCase()}">${customer.lifecycleStage}</span></p>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <h5>Tags</h5>
            <div class="customer-tags">
              ${(customer.tags || []).map(tag => `<span class="tag ${tag.toLowerCase()}">${tag}</span>`).join('') || '<span class="text-muted">No tags</span>'}
            </div>
          </div>
          <div class="col-md-6">
            <h5>Dates</h5>
            <p><strong>Added:</strong> ${new Date(customer.addedDate).toLocaleDateString()}</p>
            <p><strong>Last Contact:</strong> ${new Date(customer.lastContact).toLocaleDateString()}</p>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-12">
            <h5>Actions</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-gradient" onclick="quickMessage('${customer.id}')">
                <i class="bi bi-send me-2"></i>Send Message
              </button>
              <button class="btn btn-warning" onclick="editCustomer('${customer.id}')">
                <i class="bi bi-pencil me-2"></i>Edit
              </button>
              <button class="btn btn-danger" onclick="deleteCustomer('${customer.id}')">
                <i class="bi bi-trash me-2"></i>Delete
              </button>
            </div>
          </div>
        </div>
      `;
      
      modal.show();
    }

    // Edit Customer
    function editCustomer(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;
      
      // Fill form with customer data
      document.getElementById('firstName').value = customer.firstName;
      document.getElementById('lastName').value = customer.lastName || '';
      document.getElementById('phoneNumber').value = customer.phone;
      document.getElementById('email').value = customer.email || '';
      document.getElementById('branch').value = customer.branch;
      document.getElementById('status').value = customer.status;
      document.getElementById('lifecycleStage').value = customer.lifecycleStage;
      document.getElementById('tags').value = (customer.tags || []).join(', ');
      
      // Show add customer section
      showSection('add-customer');
      
      // Change form behavior to update instead of add
      const form = document.getElementById('addCustomerForm');
      form.dataset.customerId = customerId;
      
      // Update submit button text
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.innerHTML = '<i class="bi bi-save me-2"></i>Update Customer';
    }

    // Delete Customer
    function deleteCustomer(customerId) {
      if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
        return;
      }
      
      const index = customers.findIndex(c => c.id === customerId);
      if (index !== -1) {
        const customer = customers[index];
        customers.splice(index, 1);
        
        // Add to activity feed
        addActivity(`Deleted customer: ${customer.firstName} ${customer.lastName || ''}`);
        
        saveData();
        renderCustomers();
        updateMetrics();
        updateCharts();
        
        showToast('Customer deleted successfully', 'success');
      }
    }

    // Quick Message
    function quickMessage(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;
      
      // Select the customer
      selectedCustomers.clear();
      selectedCustomers.add(customerId);
      
      // Show messaging section
      showSection('messaging');
      
      // Set recipient type to selected
      document.getElementById('recipientType').value = 'selected';
      updateRecipients();
    }

    // Add Customer Form Submit Handler
    document.getElementById('addCustomerForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const form = e.target;
      const customerId = form.dataset.customerId;
      const isUpdate = customerId !== undefined;
      
      if (!form.checkValidity()) {
        e.stopPropagation();
        form.classList.add('was-validated');
        return;
      }
      
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const phone = document.getElementById('phoneNumber').value.trim();
      const email = document.getElementById('email').value.trim();
      const branch = document.getElementById('branch').value;
      const status = document.getElementById('status').value;
      const lifecycleStage = document.getElementById('lifecycleStage').value;
      const tags = document.getElementById('tags').value.trim();
      
      // Validate form
      if (!firstName || !phone || !branch) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      // Validate phone number
      if (!validatePhone(phone)) {
        showToast('Please enter a valid phone number', 'error');
        return;
      }
      
      // Validate email if provided
      if (email && !validateEmail(email)) {
        showToast('Please enter a valid email address', 'error');
        return;
      }
      
      // Check for duplicates (excluding current customer if updating)
      const duplicate = customers.find(c => 
        c.id !== customerId && 
        (c.phone === phone || (email && c.email === email))
      );
      
      if (duplicate) {
        showToast('A customer with this phone or email already exists', 'error');
        return;
      }
      
      if (isUpdate) {
        // Update existing customer
        const index = customers.findIndex(c => c.id === customerId);
        if (index !== -1) {
          customers[index] = {
            ...customers[index],
            firstName,
            lastName,
            phone,
            email,
            branch,
            status,
            lifecycleStage,
            tags: tags ? tags.split(',').map(t => t.trim()) : []
          };
          
          // Add to activity feed
          addActivity(`Updated customer: ${firstName} ${lastName || ''}`);
          
          showToast('Customer updated successfully!', 'success');
        }
      } else {
        // Create new customer
        const customer = {
          id: Date.now().toString(),
          firstName,
          lastName,
          phone,
          email,
          branch,
          status,
          lifecycleStage,
          tags: tags ? tags.split(',').map(t => t.trim()) : [],
          addedDate: new Date().toISOString(),
          lastContact: new Date().toISOString()
        };
        
        customers.push(customer);
        
        // Add to activity feed
        addActivity(`Added new customer: ${firstName} ${lastName || ''}`);
        
        showToast('Customer added successfully!', 'success');
      }
      
      saveData();
      form.reset();
      form.classList.remove('was-validated');
      delete form.dataset.customerId;
      
      // Reset submit button text
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.innerHTML = '<i class="bi bi-save me-2"></i>Save Customer';
      
      if (currentSection === 'customers') {
        renderCustomers();
      }
      
      updateMetrics();
      updateCharts();
    });

    // Reset Form
    function resetForm() {
      const form = document.getElementById('addCustomerForm');
      form.reset();
      form.classList.remove('was-validated');
      delete form.dataset.customerId;
      
      // Reset submit button text
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.innerHTML = '<i class="bi bi-save me-2"></i>Save Customer';
    }

    // Validate Phone
    function validatePhone(phone) {
      // Basic phone validation - can be enhanced based on requirements
      const phoneRegex = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,9}[)]?[-\s\.]?[0-9]{1,9}[-\s\.]?[0-9]{1,9}?$/;
      return phoneRegex.test(phone);
    }

    // Validate Email
    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Update Recipients
    function updateRecipients() {
      const recipientType = document.getElementById('recipientType').value;
      const branchSelection = document.getElementById('branchSelection');
      const lifecycleSelection = document.getElementById('lifecycleSelection');
      const tagsSelection = document.getElementById('tagsSelection');
      const segmentSelection = document.getElementById('segmentSelection');
      
      // Hide all selection options
      branchSelection.style.display = 'none';
      lifecycleSelection.style.display = 'none';
      tagsSelection.style.display = 'none';
      segmentSelection.style.display = 'none';
      
      // Show relevant selection option
      switch (recipientType) {
        case 'branch':
          branchSelection.style.display = 'block';
          break;
        case 'lifecycle':
          lifecycleSelection.style.display = 'block';
          break;
        case 'tags':
          tagsSelection.style.display = 'block';
          break;
        case 'segment':
          segmentSelection.style.display = 'block';
          break;
      }
      
      // Update recipients list
      updateRecipientsList();
    }

    // Update Recipients List
    function updateRecipientsList() {
      const recipientType = document.getElementById('recipientType').value;
      const msgBranch = document.getElementById('msgBranch').value;
      const msgLifecycle = document.getElementById('msgLifecycle').value;
      const msgTags = document.getElementById('msgTags').value;
      const msgSegment = document.getElementById('msgSegment').value;
      const recipientsList = document.getElementById('recipientsList');
      const recipientCount = document.getElementById('recipientCount');
      
      let recipients = [];
      
      switch (recipientType) {
        case 'all':
          recipients = customers.filter(c => c.status === 'Active');
          break;
        case 'branch':
          recipients = customers.filter(c => c.branch === msgBranch && c.status === 'Active');
          break;
        case 'lifecycle':
          recipients = customers.filter(c => c.lifecycleStage === msgLifecycle && c.status === 'Active');
          break;
        case 'tags':
          recipients = customers.filter(c => c.tags && c.tags.includes(msgTags) && c.status === 'Active');
          break;
        case 'selected':
          recipients = customers.filter(c => selectedCustomers.has(c.id));
          break;
        case 'segment':
          const segment = segments.find(s => s.id === msgSegment);
          if (segment) {
            if (segment.dynamic) {
              // Apply segment rules for dynamic segments
              recipients = customers.filter(c => {
                return segment.rules.every(rule => applyRule(c, rule));
              });
            } else {
              // Use saved customer IDs for static segments
              recipients = customers.filter(c => segment.customerIds.includes(c.id));
            }
          }
          break;
      }
      
      // Update recipient count
      recipientCount.textContent = recipients.length;
      
      // Update recipients list
      recipientsList.innerHTML = '';
      
      if (recipients.length === 0) {
        recipientsList.innerHTML = '<p class="text-muted">No recipients found</p>';
        return;
      }
      
      recipients.forEach(customer => {
        const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
        const item = document.createElement('div');
        item.className = 'd-flex justify-content-between align-items-center p-2 border-bottom';
        item.innerHTML = `
          <span>${fullName} - ${customer.phone}</span>
          <span class="badge bg-secondary">${customer.branch}</span>
        `;
        recipientsList.appendChild(item);
      });
    }

    // Load Message Templates
    function loadMessageTemplates() {
      const stored = localStorage.getItem('messageTemplates');
      if (stored) {
        messageTemplates = JSON.parse(stored);
      } else {
        // Default templates
        messageTemplates = [
          {
            id: 'welcome',
            name: 'Welcome Message',
            content: 'Hello {name}, welcome to our service! We\'re excited to have you with us.',
            variables: ['name']
          },
          {
            id: 'promotion',
            name: 'Special Promotion',
            content: 'Hi {name}, we have a special promotion just for you! Visit our store to learn more.',
            variables: ['name']
          },
          {
            id: 'reminder',
            name: 'Appointment Reminder',
            content: 'Dear {name}, this is a reminder about your upcoming appointment on {date}.',
            variables: ['name', 'date']
          },
          {
            id: 'feedback',
            name: 'Feedback Request',
            content: 'Hello {name}, we\'d love to hear your feedback about your recent experience with us.',
            variables: ['name']
          }
        ];
        saveMessageTemplates();
      }
    }

    // Save Message Templates
    function saveMessageTemplates() {
      localStorage.setItem('messageTemplates', JSON.stringify(messageTemplates));
    }

    // Update Template Dropdown
    function updateTemplateDropdown() {
      const templateSelect = document.getElementById('msgTemplate');
      if (!templateSelect) return;
      
      templateSelect.innerHTML = '<option value="">Select Template</option>';
      messageTemplates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = template.name;
        templateSelect.appendChild(option);
      });
    }

    // Load Template
    function loadTemplate() {
      const templateId = document.getElementById('msgTemplate').value;
      const msgText = document.getElementById('msgText');
      
      const template = messageTemplates.find(t => t.id === templateId);
      if (template) {
        msgText.value = template.content;
      }
    }

    // Manage Message Templates
    function manageMessageTemplates() {
      const modal = new bootstrap.Modal(document.getElementById('templateModal'));
      const templateManager = document.getElementById('templateManager');
      
      templateManager.innerHTML = `
        <div class="template-list">
          ${messageTemplates.map(template => `
            <div class="template-item">
              <h5>${template.name}</h5>
              <p>${template.content}</p>
              <small class="text-muted">Variables: ${template.variables.join(', ')}</small>
              <div class="template-actions">
                <button class="btn btn-sm btn-primary" onclick="editTemplate('${template.id}')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteTemplate('${template.id}')">Delete</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      modal.show();
    }

    // Show Add Template Form
    function showAddTemplateForm() {
      const templateManager = document.getElementById('templateManager');
      
      templateManager.innerHTML = `
        <form id="addTemplateForm">
          <div class="form-floating-custom">
            <label class="form-label">Template Name</label>
            <input type="text" class="form-control-custom" id="templateName" required>
          </div>
          <div class="form-floating-custom">
            <label class="form-label">Message Content</label>
            <textarea class="form-control-custom" id="templateContent" rows="4" required></textarea>
            <small class="text-muted">Use {name}, {date}, etc. for variables</small>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-gradient">Save Template</button>
            <button type="button" class="btn btn-secondary" onclick="manageMessageTemplates()">Cancel</button>
          </div>
        </form>
      `;
      
      document.getElementById('addTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('templateName').value.trim();
        const content = document.getElementById('templateContent').value.trim();
        
        if (!name || !content) {
          showToast('Please fill in all fields', 'error');
          return;
        }
        
        // Extract variables from content
        const variables = content.match(/\{([^}]+)\}/g)?.map(v => v.slice(1, -1)) || [];
        
        const template = {
          id: Date.now().toString(),
          name,
          content,
          variables
        };
        
        messageTemplates.push(template);
        saveMessageTemplates();
        
        showToast('Template added successfully', 'success');
        manageMessageTemplates();
        updateTemplateDropdown();
      });
    }

    // Edit Template
    function editTemplate(templateId) {
      const template = messageTemplates.find(t => t.id === templateId);
      if (!template) return;
      
      const templateManager = document.getElementById('templateManager');
      
      templateManager.innerHTML = `
        <form id="editTemplateForm">
          <div class="form-floating-custom">
            <label class="form-label">Template Name</label>
            <input type="text" class="form-control-custom" id="templateName" value="${template.name}" required>
          </div>
          <div class="form-floating-custom">
            <label class="form-label">Message Content</label>
            <textarea class="form-control-custom" id="templateContent" rows="4" required>${template.content}</textarea>
            <small class="text-muted">Use {name}, {date}, etc. for variables</small>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-gradient">Update Template</button>
            <button type="button" class="btn btn-secondary" onclick="manageMessageTemplates()">Cancel</button>
          </div>
        </form>
      `;
      
      document.getElementById('editTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('templateName').value.trim();
        const content = document.getElementById('templateContent').value.trim();
        
        if (!name || !content) {
          showToast('Please fill in all fields', 'error');
          return;
        }
        
        // Extract variables from content
        const variables = content.match(/\{([^}]+)\}/g)?.map(v => v.slice(1, -1)) || [];
        
        // Update template
        template.name = name;
        template.content = content;
        template.variables = variables;
        
        saveMessageTemplates();
        
        showToast('Template updated successfully', 'success');
        manageMessageTemplates();
        updateTemplateDropdown();
      });
    }

    // Delete Template
    function deleteTemplate(templateId) {
      if (!confirm('Are you sure you want to delete this template?')) {
        return;
      }
      
      const index = messageTemplates.findIndex(t => t.id === templateId);
      if (index !== -1) {
        messageTemplates.splice(index, 1);
        saveMessageTemplates();
        
        showToast('Template deleted', 'success');
        manageMessageTemplates();
        updateTemplateDropdown();
      }
    }

    // Toggle Schedule
    function toggleSchedule() {
      const scheduleOptions = document.getElementById('scheduleOptions');
      const isChecked = document.getElementById('scheduleMessage').checked;
      
      scheduleOptions.style.display = isChecked ? 'block' : 'none';
    }

    // Send Messages Optimized
    function sendMessagesOptimized() {
      const msgType = document.querySelector('input[name="msgType"]:checked').value;
      const msgText = document.getElementById('msgText').value.trim();
      const isScheduled = document.getElementById('scheduleMessage').checked;
      const scheduleDateTime = document.getElementById('scheduleDateTime').value;
      
      if (!msgText) {
        showToast('Please enter a message', 'error');
        return;
      }
      
      const recipients = getRecipients();
      
      if (recipients.length === 0) {
        showToast('No recipients found', 'error');
        return;
      }
      
      // Show progress
      const messageProgress = document.getElementById('messageProgress');
      const progressList = document.getElementById('progressList');
      messageProgress.classList.add('active');
      progressList.innerHTML = '';
      
      // Add to activity feed
      addActivity(`Started sending ${msgType} messages to ${recipients.length} recipients`);
      
      // Batch sending configuration
      const batchSize = 10;
      const batchDelay = 1000;
      
      // Send messages in batches
      sendBatchMessages(recipients, msgText, msgType, batchSize, batchDelay);
    }

    // Send Batch Messages
    function sendBatchMessages(recipients, msgText, msgType, batchSize, batchDelay) {
      const progressList = document.getElementById('progressList');
      let sentCount = 0;
      let failedCount = 0;
      let currentBatch = 0;
      const totalBatches = Math.ceil(recipients.length / batchSize);
      
      function sendNextBatch() {
        if (currentBatch >= totalBatches) {
          // All batches sent
          setTimeout(() => {
            showToast(`Messages sent: ${sentCount}, Failed: ${failedCount}`, sentCount > 0 ? 'success' : 'error');
            
            // Add to activity feed
            addActivity(`Completed sending ${msgType} messages: ${sentCount} sent, ${failedCount} failed`);
            
            // Save data
            saveData();
            updateMetrics();
            updateCharts();
            
            // Show WhatsApp links if applicable
            if (msgType === 'whatsapp' && sentCount > 0) {
              showWhatsAppLinks(recipients.filter((_, i) => Math.random() > 0.1), msgText);
            }
          }, 1000);
          return;
        }
        
        // Calculate batch range
        const startIndex = currentBatch * batchSize;
        const endIndex = Math.min(startIndex + batchSize, recipients.length);
        const batch = recipients.slice(startIndex, endIndex);
        
        // Send current batch
        batch.forEach((customer, index) => {
          const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
          const personalizedMessage = msgText.replace(/{name}/g, fullName);
          
          // Create progress item
          const progressItem = document.createElement('div');
          progressItem.className = 'progress-item sending';
          progressItem.innerHTML = `
            <div>
              <strong>${fullName}</strong> - ${customer.phone}
              <div class="small text-muted">${personalizedMessage.substring(0, 50)}...</div>
            </div>
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Sending...</span>
            </div>
          `;
          progressList.appendChild(progressItem);
          
          // Simulate sending
          setTimeout(() => {
            const success = Math.random() > 0.1; // 90% success rate
            
            if (success) {
              sentCount++;
              progressItem.className = 'progress-item sent';
              progressItem.querySelector('.spinner-border').outerHTML = '<i class="bi bi-check-circle text-success"></i>';
              
              // Log message
              messageLog.push({
                id: Date.now().toString() + index,
                customerId: customer.id,
                type: msgType,
                message: personalizedMessage,
                status: 'sent',
                sentAt: new Date().toISOString()
              });
              
              // Update customer
              customer.lastMessageDate = new Date().toISOString();
              customer.lastContact = new Date().toISOString();
            } else {
              failedCount++;
              progressItem.className = 'progress-item failed';
              progressItem.querySelector('.spinner-border').outerHTML = '<i class="bi bi-x-circle text-danger"></i>';
              
              // Log failed message
              messageLog.push({
                id: Date.now().toString() + index,
                customerId: customer.id,
                type: msgType,
                message: personalizedMessage,
                status: 'failed',
                sentAt: new Date().toISOString()
              });
            }
            
            // Check if batch is complete
            if (index === batch.length - 1) {
              currentBatch++;
              setTimeout(sendNextBatch, batchDelay);
            }
          }, 200 + (index * 50));
        });
      }
      
      // Start sending
      sendNextBatch();
    }

    // Get Recipients
    function getRecipients() {
      const recipientType = document.getElementById('recipientType').value;
      let recipients = [];
      
      switch (recipientType) {
        case 'all':
          recipients = customers.filter(c => c.status === 'Active');
          break;
        case 'branch':
          const msgBranch = document.getElementById('msgBranch').value;
          recipients = customers.filter(c => c.branch === msgBranch && c.status === 'Active');
          break;
        case 'lifecycle':
          const msgLifecycle = document.getElementById('msgLifecycle').value;
          recipients = customers.filter(c => c.lifecycleStage === msgLifecycle && c.status === 'Active');
          break;
        case 'tags':
          const msgTags = document.getElementById('msgTags').value;
          recipients = customers.filter(c => c.tags && c.tags.includes(msgTags) && c.status === 'Active');
          break;
        case 'selected':
          recipients = customers.filter(c => selectedCustomers.has(c.id));
          break;
        case 'segment':
          const msgSegment = document.getElementById('msgSegment').value;
          const segment = segments.find(s => s.id === msgSegment);
          if (segment) {
            if (segment.dynamic) {
              recipients = customers.filter(c => {
                return segment.rules.every(rule => applyRule(c, rule));
              });
            } else {
              recipients = customers.filter(c => segment.customerIds.includes(c.id));
            }
          }
          break;
      }
      
      return recipients;
    }

    // Show WhatsApp Links
    function showWhatsAppLinks(recipients, message) {
      const whatsappLinks = document.getElementById('whatsappLinks');
      const whatsappLinksList = document.getElementById('whatsappLinksList');
      
      whatsappLinks.classList.add('active');
      whatsappLinksList.innerHTML = '';
      
      recipients.forEach(customer => {
        const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
        const personalizedMessage = message.replace(/{name}/g, fullName);
        const encodedMessage = encodeURIComponent(personalizedMessage);
        const whatsappUrl = `https://wa.me/${customer.phone.replace(/[^\d]/g, '')}?text=${encodedMessage}`;
        
        const linkItem = document.createElement('div');
        linkItem.className = 'whatsapp-link-item';
        linkItem.innerHTML = `
          <div>
            <strong>${fullName}</strong> - ${customer.phone}
          </div>
          <a href="${whatsappUrl}" target="_blank" class="btn btn-success btn-sm">
            <i class="bi bi-whatsapp me-1"></i>Open WhatsApp
          </a>
        `;
        
        whatsappLinksList.appendChild(linkItem);
      });
    }

    // Render Follow-ups
    function renderFollowups() {
      const followupsList = document.getElementById('followupsList');
      if (!followupsList) return;
      
      // Sort follow-ups by due date
      const sortedFollowups = [...followups].sort((a, b) => {
        return new Date(a.dueDate) - new Date(b.dueDate);
      });
      
      followupsList.innerHTML = '';
      
      if (sortedFollowups.length === 0) {
        followupsList.innerHTML = '<p class="text-muted">No follow-ups scheduled</p>';
        return;
      }
      
      sortedFollowups.forEach(followup => {
        const customer = customers.find(c => c.id === followup.customerId);
        if (!customer) return;
        
        const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
        const dueDate = new Date(followup.dueDate);
        const now = new Date();
        const isOverdue = dueDate < now;
        
        const followupItem = document.createElement('div');
        followupItem.className = `follow-up-item ${isOverdue ? 'overdue' : ''}`;
        followupItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5>${followup.type} with ${fullName}</h5>
              <p class="mb-1">${followup.notes || 'No notes'}</p>
              <small class="text-muted">Due: ${dueDate.toLocaleDateString()} at ${dueDate.toLocaleTimeString()}</small>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-success" onclick="completeFollowup('${followup.id}')">
                <i class="bi bi-check"></i> Complete
              </button>
              <button class="btn btn-sm btn-warning" onclick="rescheduleFollowup('${followup.id}')">
                <i class="bi bi-clock"></i> Reschedule
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteFollowup('${followup.id}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
        
        followupsList.appendChild(followupItem);
      });
    }

    // Show Add Follow-up Modal
    function showAddFollowupModal() {
      const modal = new bootstrap.Modal(document.getElementById('addFollowupModal'));
      const customerSelect = document.getElementById('followupCustomer');
      
      // Populate customer dropdown
      customerSelect.innerHTML = '<option value="">Select Customer</option>';
      customers.forEach(customer => {
        const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${fullName} - ${customer.branch}`;
        customerSelect.appendChild(option);
      });
      
      // Set default due date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('followupDate').value = tomorrow.toISOString().slice(0, 16);
      
      modal.show();
    }

    // Add Follow-up
    function addFollowup() {
      const customerId = document.getElementById('followupCustomer').value;
      const type = document.getElementById('followupType').value;
      const dueDate = document.getElementById('followupDate').value;
      const notes = document.getElementById('followupNotes').value.trim();
      
      if (!customerId || !dueDate) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;
      
      const followup = {
        id: Date.now().toString(),
        customerId,
        type,
        dueDate,
        notes,
        status: 'pending',
        createdAt: new Date().toISOString()
      };
      
      followups.push(followup);
      
      // Add to activity feed
      const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
      addActivity(`Scheduled ${type} follow-up with ${fullName} for ${new Date(dueDate).toLocaleDateString()}`);
      
      saveData();
      renderFollowups();
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('addFollowupModal'));
      modal.hide();
      
      // Reset form
      document.getElementById('addFollowupForm').reset();
      
      showToast('Follow-up scheduled successfully', 'success');
    }

    // Complete Follow-up
    function completeFollowup(followupId) {
      const index = followups.findIndex(f => f.id === followupId);
      if (index !== -1) {
        const followup = followups[index];
        followup.status = 'completed';
        followup.completedAt = new Date().toISOString();
        
        // Add to activity feed
        const customer = customers.find(c => c.id === followup.customerId);
        if (customer) {
          const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
          addActivity(`Completed ${followup.type} follow-up with ${fullName}`);
        }
        
        saveData();
        renderFollowups();
        
        showToast('Follow-up marked as completed', 'success');
      }
    }

    // Reschedule Follow-up
    function rescheduleFollowup(followupId) {
      const index = followups.findIndex(f => f.id === followupId);
      if (index !== -1) {
        const followup = followups[index];
        
        // Simple prompt for new date - in a real app, this would be a proper date picker
        const newDateStr = prompt('Enter new date and time (YYYY-MM-DD HH:MM):', new Date(followup.dueDate).toISOString().slice(0, 16));
        
        if (newDateStr) {
          const newDate = new Date(newDateStr);
          if (!isNaN(newDate.getTime())) {
            followup.dueDate = newDate.toISOString();
            
            // Add to activity feed
            const customer = customers.find(c => c.id === followup.customerId);
            if (customer) {
              const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
              addActivity(`Rescheduled ${followup.type} follow-up with ${fullName} to ${newDate.toLocaleDateString()}`);
            }
            
            saveData();
            renderFollowups();
            
            showToast('Follow-up rescheduled successfully', 'success');
          } else {
            showToast('Invalid date format', 'error');
          }
        }
      }
    }

    // Delete Follow-up
    function deleteFollowup(followupId) {
      if (!confirm('Are you sure you want to delete this follow-up?')) {
        return;
      }
      
      const index = followups.findIndex(f => f.id === followupId);
      if (index !== -1) {
        const followup = followups[index];
        
        // Add to activity feed
        const customer = customers.find(c => c.id === followup.customerId);
        if (customer) {
          const fullName = `${customer.firstName} ${customer.lastName || ''}`.trim();
          addActivity(`Deleted ${followup.type} follow-up with ${fullName}`);
        }
        
        followups.splice(index, 1);
        saveData();
        renderFollowups();
        
        showToast('Follow-up deleted', 'success');
      }
    }

    // Check Follow-up Reminders
    function checkFollowupReminders() {
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      // Find follow-ups due in the next 24 hours
      const upcomingFollowups = followups.filter(f => {
        if (f.status !== 'pending') return false;
        
        const dueDate = new Date(f.dueDate);
        return dueDate >= now && dueDate <= tomorrow;
      });
      
      if (upcomingFollowups.length > 0) {
        // Show notification
        showToast(`You have ${upcomingFollowups.length} follow-up(s) due in the next 24 hours`, 'warning');
        
        // Add to activity feed
        addActivity(`System: Found ${upcomingFollowups.length} follow-up(s) due in the next 24 hours`);
      }
    }

    // Render Tasks
    function renderTasks() {
      const taskList = document.getElementById('taskList');
      if (!taskList) return;
      
      // Sort tasks by priority and due date
      const sortedTasks = [...tasks].sort((a, b) => {
        // First by priority (urgent first)
        const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
        const aPriority = priorityOrder[a.priority] || 3;
        const bPriority = priorityOrder[b.priority] || 3;
        
        if (aPriority !== bPriority) {
          return aPriority - bPriority;
        }
        
        // Then by due date
        return new Date(a.dueDate) - new Date(b.dueDate);
      });
      
      taskList.innerHTML = '';
      
      if (sortedTasks.length === 0) {
        taskList.innerHTML = '<p class="text-muted">No tasks found</p>';
        return;
      }
      
      sortedTasks.forEach(task => {
        const dueDate = new Date(task.dueDate);
        const now = new Date();
        const isOverdue = dueDate < now && task.status !== 'completed';
        
        const taskItem = document.createElement('div');
        taskItem.className = `task-item ${task.status === 'completed' ? 'completed' : ''}`;
        taskItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center mb-2">
                <h5 class="mb-0 me-2">${task.title}</h5>
                <span class="task-priority priority-${task.priority}">${task.priority}</span>
                ${isOverdue ? '<span class="badge bg-danger ms-2">Overdue</span>' : ''}
              </div>
              <p class="mb-1">${task.description || 'No description'}</p>
              <small class="text-muted">Due: ${dueDate.toLocaleDateString()} at ${dueDate.toLocaleTimeString()}</small>
              ${task.assignedTo ? `<small class="text-muted d-block">Assigned to: ${task.assignedTo}</small>` : ''}
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm ${task.status === 'completed' ? 'btn-secondary' : 'btn-success'}" 
                      onclick="toggleTaskStatus('${task.id}')">
                <i class="bi ${task.status === 'completed' ? 'bi-arrow-counterclockwise' : 'bi-check'}"></i> 
                ${task.status === 'completed' ? 'Reopen' : 'Complete'}
              </button>
              <button class="btn btn-sm btn-warning" onclick="editTask('${task.id}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteTask('${task.id}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
        
        taskList.appendChild(taskItem);
      });
    }

    // Create Task
    function createTask() {
      // Simple prompt for task details - in a real app, this would be a proper form
      const title = prompt('Task title:');
      if (!title) return;
      
      const description = prompt('Task description:');
      const priority = prompt('Priority (low, medium, high, urgent):') || 'medium';
      const dueDateStr = prompt('Due date (YYYY-MM-DD):');
      const assignedTo = prompt('Assigned to (optional):');
      
      if (!dueDateStr) return;
      
      const dueDate = new Date(dueDateStr);
      if (isNaN(dueDate.getTime())) {
        showToast('Invalid date format', 'error');
        return;
      }
      
      const task = {
        id: Date.now().toString(),
        title,
        description,
        priority: ['low', 'medium', 'high', 'urgent'].includes(priority) ? priority : 'medium',
        dueDate: dueDate.toISOString(),
        assignedTo,
        status: 'pending',
        createdAt: new Date().toISOString()
      };
      
      tasks.push(task);
      
      // Add to activity feed
      addActivity(`Created new task: ${title}`);
      
      saveData();
      renderTasks();
      
      showToast('Task created successfully', 'success');
    }

    // Toggle Task Status
    function toggleTaskStatus(taskId) {
      const index = tasks.findIndex(t => t.id === taskId);
      if (index !== -1) {
        const task = tasks[index];
        task.status = task.status === 'completed' ? 'pending' : 'completed';
        
        if (task.status === 'completed') {
          task.completedAt = new Date().toISOString();
        }
        
        // Add to activity feed
        addActivity(`${task.status === 'completed' ? 'Completed' : 'Reopened'} task: ${task.title}`);
        
        saveData();
        renderTasks();
        
        showToast(`Task ${task.status === 'completed' ? 'completed' : 'reopened'}`, 'success');
      }
    }

    // Edit Task
    function editTask(taskId) {
      const index = tasks.findIndex(t => t.id === taskId);
      if (index !== -1) {
        const task = tasks[index];
        
        // Simple prompts for editing - in a real app, this would be a proper form
        const title = prompt('Task title:', task.title);
        if (!title) return;
        
        const description = prompt('Task description:', task.description);
        const priority = prompt('Priority (low, medium, high, urgent):', task.priority) || 'medium';
        const dueDateStr = prompt('Due date (YYYY-MM-DD):', new Date(task.dueDate).toISOString().slice(0, 10));
        const assignedTo = prompt('Assigned to (optional):', task.assignedTo || '');
        
        if (!dueDateStr) return;
        
        const dueDate = new Date(dueDateStr);
        if (isNaN(dueDate.getTime())) {
          showToast('Invalid date format', 'error');
          return;
        }
        
        task.title = title;
        task.description = description;
        task.priority = ['low', 'medium', 'high', 'urgent'].includes(priority) ? priority : 'medium';
        task.dueDate = dueDate.toISOString();
        task.assignedTo = assignedTo;
        
        // Add to activity feed
        addActivity(`Updated task: ${task.title}`);
        
        saveData();
        renderTasks();
        
        showToast('Task updated successfully', 'success');
      }
    }

    // Delete Task
    function deleteTask(taskId) {
      if (!confirm('Are you sure you want to delete this task?')) {
        return;
      }
      
      const index = tasks.findIndex(t => t.id === taskId);
      if (index !== -1) {
        const task = tasks[index];
        
        // Add to activity feed
        addActivity(`Deleted task: ${task.title}`);
        
        tasks.splice(index, 1);
        saveData();
        renderTasks();
        
        showToast('Task deleted', 'success');
      }
    }

    // Filter Tasks
    function filterTasks() {
      // Simple filter by status - in a real app, this would be more sophisticated
      const status = prompt('Filter by status (all, pending, completed):', 'all');
      
      if (!status) return;
      
      let filteredTasks = tasks;
      
      if (status !== 'all') {
        filteredTasks = tasks.filter(t => t.status === status);
      }
      
      // Temporarily replace tasks array with filtered results
      const originalTasks = [...tasks];
      tasks = filteredTasks;
      renderTasks();
      
      // Restore original tasks after a short delay
      setTimeout(() => {
        tasks = originalTasks;
        renderTasks();
      }, 5000);
      
      showToast(`Showing ${status} tasks (5 seconds)`, 'info');
    }

    // Render Activity Feed
    function renderActivityFeed() {
      const activityFeedElement = document.getElementById('recentActivity');
      if (!activityFeedElement) return;
      
      // Sort activities by date (newest first)
      const sortedActivities = [...activityFeed].sort((a, b) => {
        return new Date(b.timestamp) - new Date(a.timestamp);
      });
      
      // Get only the 10 most recent activities
      const recentActivities = sortedActivities.slice(0, 10);
      
      activityFeedElement.innerHTML = '';
      
      if (recentActivities.length === 0) {
        activityFeedElement.innerHTML = '<p class="text-muted">No recent activity</p>';
        return;
      }
      
      recentActivities.forEach(activity => {
        const date = new Date(activity.timestamp);
        const activityItem = document.createElement('div');
        activityItem.className = 'activity-item';
        activityItem.innerHTML = `
          <div>${activity.description}</div>
          <div class="activity-time">${date.toLocaleDateString()} at ${date.toLocaleTimeString()}</div>
        `;
        
        activityFeedElement.appendChild(activityItem);
      });
    }

    // Add Activity
    function addActivity(description) {
      const activity = {
        id: Date.now().toString(),
        description,
        timestamp: new Date().toISOString()
      };
      
      activityFeed.push(activity);
      
      // Keep only the last 100 activities
      if (activityFeed.length > 100) {
        activityFeed = activityFeed.slice(-100);
      }
      
      // Update activity feed if on dashboard
      if (currentSection === 'dashboard') {
        renderActivityFeed();
      }
      
      saveData();
    }

    // Initialize Charts
    function initializeCharts() {
      // Customer Growth Chart
      const growthCtx = document.getElementById('customerGrowthChart');
      if (growthCtx) {
        charts.growth = new Chart(growthCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'New Customers',
              data: [],
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      // Branch Distribution Chart
      const branchCtx = document.getElementById('branchDistributionChart');
      if (branchCtx) {
        charts.branch = new Chart(branchCtx, {
          type: 'doughnut',
          data: {
            labels: [],
            datasets: [{
              data: [],
              backgroundColor: [
                '#667eea',
                '#764ba2',
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#17a2b8',
                '#fd7e14'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right'
              }
            }
          }
        });
      }

      // Message Stats Chart
      const messageCtx = document.getElementById('messageStatsChart');
      if (messageCtx) {
        charts.message = new Chart(messageCtx, {
          type: 'bar',
          data: {
            labels: ['WhatsApp', 'SMS', 'Email'],
            datasets: [{
              label: 'Messages Sent',
              data: [0, 0, 0],
              backgroundColor: [
                '#25D366',
                '#007BFF',
                '#17a2b8'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      // Status Chart
      const statusCtx = document.getElementById('statusChart');
      if (statusCtx) {
        charts.status = new Chart(statusCtx, {
          type: 'pie',
          data: {
            labels: ['Active', 'Inactive', 'Opt-Out'],
            datasets: [{
              data: [0, 0, 0],
              backgroundColor: [
                '#28a745',
                '#ffc107',
                '#dc3545'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right'
              }
            }
          }
        });
      }

      // Lifecycle Chart
      const lifecycleCtx = document.getElementById('lifecycleChart');
      if (lifecycleCtx) {
        charts.lifecycle = new Chart(lifecycleCtx, {
          type: 'bar',
          data: {
            labels: ['Lead', 'Prospect', 'Active', 'Churned', 'Reactivated'],
            datasets: [{
              label: 'Customers',
              data: [0, 0, 0, 0, 0],
              backgroundColor: [
                '#6c757d',
                '#17a2b8',
                '#28a745',
                '#dc3545',
                '#ffc107'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      // Retention Chart
      const retentionCtx = document.getElementById('retentionChart');
      if (retentionCtx) {
        charts.retention = new Chart(retentionCtx, {
          type: 'line',
          data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
            datasets: [{
              label: 'Retention Rate %',
              data: [100, 85, 75, 70, 65, 60],
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100
              }
            }
          }
        });
      }
      
      debug('Charts initialized');
    }

    // Update Charts with real data
    function updateCharts() {
      // Update Branch Distribution
      if (charts.branch) {
        const branchCounts = {};
        customers.forEach(c => {
          branchCounts[c.branch] = (branchCounts[c.branch] || 0) + 1;
        });
        
        charts.branch.data.labels = Object.keys(branchCounts);
        charts.branch.data.datasets[0].data = Object.values(branchCounts);
        charts.branch.update();
      }

      // Update Message Stats
      if (charts.message) {
        const messageCounts = { whatsapp: 0, sms: 0, email: 0 };
        messageLog.forEach(log => {
          if (messageCounts.hasOwnProperty(log.type)) {
            messageCounts[log.type]++;
          }
        });
        
        charts.message.data.datasets[0].data = [
          messageCounts.whatsapp,
          messageCounts.sms,
          messageCounts.email
        ];
        charts.message.update();
      }

      // Update Status Chart
      if (charts.status) {
        const statusCounts = { Active: 0, Inactive: 0, 'Opt-Out': 0 };
        customers.forEach(c => {
          if (statusCounts.hasOwnProperty(c.status)) {
            statusCounts[c.status]++;
          }
        });
        
        charts.status.data.datasets[0].data = [
          statusCounts.Active,
          statusCounts.Inactive,
          statusCounts['Opt-Out']
        ];
        charts.status.update();
      }

      // Update Lifecycle Chart
      if (charts.lifecycle) {
        const lifecycleCounts = { LEAD: 0, PROSPECT: 0, ACTIVE: 0, CHURNED: 0, REACTIVATED: 0 };
        customers.forEach(c => {
          if (lifecycleCounts.hasOwnProperty(c.lifecycleStage)) {
            lifecycleCounts[c.lifecycleStage]++;
          }
        });
        
        charts.lifecycle.data.datasets[0].data = [
          lifecycleCounts.LEAD,
          lifecycleCounts.PROSPECT,
          lifecycleCounts.ACTIVE,
          lifecycleCounts.CHURNED,
          lifecycleCounts.REACTIVATED
        ];
        charts.lifecycle.update();
      }

      // Update Customer Growth
      if (charts.growth) {
        const monthlyData = getMonthlyCustomerCount();
        charts.growth.data.labels = monthlyData.labels;
        charts.growth.data.datasets[0].data = monthlyData.data;
        charts.growth.update();
      }

      // Update Retention Chart
      if (charts.retention) {
        const retentionData = calculateRetentionData();
        charts.retention.data.datasets[0].data = retentionData;
        charts.retention.update();
      }
    }

    // Calculate retention data
    function calculateRetentionData() {
      // This is a simplified calculation - in a real app, this would be more complex
      const weeks = 6;
      const data = [];
      
      for (let i = 0; i < weeks; i++) {
        // Start with 100% and decrease each week
        const retentionRate = Math.max(60, 100 - (i * 7));
        data.push(retentionRate);
      }
      
      return data;
    }

    // Get Monthly Customer Count
    function getMonthlyCustomerCount() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const currentMonth = new Date().getMonth();
      const data = [];
      
      // Get data for the last 6 months
      for (let i = 5; i >= 0; i--) {
        const monthIndex = (currentMonth - i + 12) % 12;
        const monthStart = new Date();
        monthStart.setMonth(monthIndex, 1);
        monthStart.setHours(0, 0, 0, 0);
        
        const monthEnd = new Date(monthStart);
        monthEnd.setMonth(monthEnd.getMonth() + 1);
        
        const count = customers.filter(c => {
          const addedDate = new Date(c.addedDate);
          return addedDate >= monthStart && addedDate < monthEnd;
        }).length;
        
        data.push(count);
      }
      
      return {
        labels: months.slice((currentMonth - 5 + 12) % 12, (currentMonth + 1) % 12),
        data: data
      };
    }

    // Show Export Modal
    function showExportModal() {
      const modal = new bootstrap.Modal(document.getElementById('exportModal'));
      modal.show();
    }

    // Export Data Enhanced
    function exportDataEnhanced() {
      showLoadingOverlay();
      
      setTimeout(() => {
        try {
          const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;
          const selectedFields = Array.from(document.querySelectorAll('.export-field:checked'))
            .map(field => field.value);
          
          if (selectedFields.length === 0) {
            showToast('Please select at least one field to export', 'error');
            hideLoadingOverlay();
            return;
          }
          
          let data, filename, mimeType;
          
          switch (exportFormat) {
            case 'csv':
              data = convertToCSV(customers, selectedFields);
              filename = `customers_${new Date().toISOString().slice(0, 10)}.csv`;
              mimeType = 'text/csv';
              break;
            case 'json':
              data = JSON.stringify(customers.map(c => {
                const filtered = {};
                selectedFields.forEach(field => {
                  filtered[field] = c[field];
                });
                return filtered;
              }), null, 2);
              filename = `customers_${new Date().toISOString().slice(0, 10)}.json`;
              mimeType = 'application/json';
              break;
            case 'excel':
              // For Excel export, we'll create a CSV that can be opened in Excel
              data = convertToCSV(customers, selectedFields);
              filename = `customers_${new Date().toISOString().slice(0, 10)}.csv`;
              mimeType = 'text/csv';
              showToast('Note: CSV format selected. Open in Excel for best results', 'info');
              break;
          }
          
          downloadFile(data, filename, mimeType);
          
          // Add to activity feed
          addActivity(`Exported customer data in ${exportFormat.toUpperCase()} format`);
          
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
          modal.hide();
          
          showToast('Data exported successfully', 'success');
        } catch (error) {
          console.error('Error exporting data:', error);
          showToast('Error exporting data', 'error');
        } finally {
          hideLoadingOverlay();
        }
      }, 1000);
    }

    // Convert to CSV
    function convertToCSV(data, fields) {
      const headers = fields.join(',');
      const rows = data.map(item => {
        return fields.map(field => {
          const value = item[field] || '';
          // Handle nested arrays (like tags)
          if (Array.isArray(value)) {
            return `"${value.join('; ')}"`;
          }
          // Escape quotes and wrap in quotes
          return `"${value.toString().replace(/"/g, '""')}"`;
        }).join(',');
      }).join('\n');
      
      return `${headers}\n${rows}`;
    }

    // Download File
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // Backup Data
    function backupData() {
      showLoadingOverlay();
      
      setTimeout(() => {
        try {
          // In a real app, this would send data to a server
          // For this demo, we'll just save to localStorage with a backup flag
          const backupData = {
            customers,
            messageLog,
            followups,
            tasks,
            activityFeed,
            settings,
            segments,
            messageTemplates,
            backupDate: new Date().toISOString()
          };
          
          localStorage.setItem('crm_backup', JSON.stringify(backupData));
          
          // Add to activity feed
          addActivity('Created data backup');
          
          showToast('Backup created successfully', 'success');
        } catch (error) {
          console.error('Error creating backup:', error);
          showToast('Error creating backup', 'error');
        } finally {
          hideLoadingOverlay();
        }
      }, 1000);
    }

    // Clear All Data
    function clearAllData() {
      if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
        return;
      }
      
      if (!confirm('This will permanently delete all customers, messages, follow-ups, and tasks. Are you absolutely sure?')) {
        return;
      }
      
      showLoadingOverlay();
      
      setTimeout(() => {
        try {
          // Clear all data
          customers = [];
          messageLog = [];
          followups = [];
          tasks = [];
          activityFeed = [];
          segments = [];
          messageTemplates = [];
          
          // Save empty data
          saveData();
          
          // Update UI
          renderCustomers();
          renderFollowups();
          renderTasks();
          renderActivityFeed();
          updateMetrics();
          updateCharts();
          
          showToast('All data cleared successfully', 'success');
        } catch (error) {
          console.error('Error clearing data:', error);
          showToast('Error clearing data', 'error');
        } finally {
          hideLoadingOverlay();
        }
      }, 1000);
    }

    // Show Import Modal
    function showImportModal() {
      const modal = new bootstrap.Modal(document.getElementById('importModal'));
      modal.show();
    }

    // Close Import Modal
    function closeImportModal() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
      modal.hide();
      
      // Reset file input
      document.getElementById('importFile').value = '';
      document.getElementById('importPreview').style.display = 'none';
    }

    // Import File Change Handler
    document.getElementById('importFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const csv = event.target.result;
          const lines = csv.split('\n');
          const headers = lines[0].split(',').map(h => h.trim());
          
          // Validate headers
          const requiredHeaders = ['firstName', 'lastName', 'phone', 'email', 'branch'];
          const hasRequiredHeaders = requiredHeaders.every(h => headers.includes(h));
          
          if (!hasRequiredHeaders) {
            showToast('CSV file is missing required columns', 'error');
            return;
          }
          
          // Parse CSV data
          const data = [];
          for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            
            const values = lines[i].split(',').map(v => v.trim());
            const row = {};
            
            headers.forEach((header, index) => {
              row[header] = values[index] || '';
            });
            
            data.push(row);
          }
          
          // Show preview
          showImportPreview(data);
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showToast('Error parsing CSV file', 'error');
        }
      };
      
      reader.readAsText(file);
    });

    // Show Import Preview
    function showImportPreview(data) {
      const preview = document.getElementById('importPreview');
      const previewBody = document.getElementById('importPreviewBody');
      
      previewBody.innerHTML = '';
      
      // Show only first 5 rows in preview
      const previewData = data.slice(0, 5);
      
      previewData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.firstName || ''}</td>
          <td>${row.lastName || ''}</td>
          <td>${row.phone || ''}</td>
          <td>${row.email || ''}</td>
          <td>${row.branch || ''}</td>
          <td>${row.status || 'Active'}</td>
        `;
        previewBody.appendChild(tr);
      });
      
      // Store data for import
      window.importData = data;
      
      preview.style.display = 'block';
      
      if (data.length > 5) {
        previewBody.innerHTML += `
          <tr>
            <td colspan="6" class="text-center">... and ${data.length - 5} more rows</td>
          </tr>
        `;
      }
    }

    // Confirm Import
    function confirmImport() {
      if (!window.importData || window.importData.length === 0) {
        showToast('No data to import', 'error');
        return;
      }
      
      showLoadingOverlay();
      
      setTimeout(() => {
        try {
          let importCount = 0;
          let duplicateCount = 0;
          
          window.importData.forEach(row => {
            // Check for duplicates
            const duplicate = customers.find(c => 
              c.phone === row.phone || (row.email && c.email === row.email)
            );
            
            if (duplicate) {
              duplicateCount++;
              return;
            }
            
            // Create customer
            const customer = {
              id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
              firstName: row.firstName || '',
              lastName: row.lastName || '',
              phone: row.phone || '',
              email: row.email || '',
              branch: row.branch || '',
              status: row.status || 'Active',
              lifecycleStage: row.lifecycleStage || 'LEAD',
              tags: row.tags ? row.tags.split(';').map(t => t.trim()) : [],
              addedDate: new Date().toISOString(),
              lastContact: new Date().toISOString()
            };
            
            customers.push(customer);
            importCount++;
          });
          
          // Add to activity feed
          addActivity(`Imported ${importCount} customers (${duplicateCount} duplicates skipped)`);
          
          saveData();
          renderCustomers();
          updateMetrics();
          updateCharts();
          
          showToast(`Imported ${importCount} customers successfully (${duplicateCount} duplicates skipped)`, 'success');
          
          // Close modal
          closeImportModal();
        } catch (error) {
          console.error('Error importing data:', error);
          showToast('Error importing data', 'error');
        } finally {
          hideLoadingOverlay();
        }
      }, 1000);
    }

    // Generate Report
    function generateReport() {
      showLoadingOverlay();
      
      setTimeout(() => {
        try {
          // Calculate report data
          const totalCustomers = customers.length;
          const activeCustomers = customers.filter(c => c.status === 'Active').length;
          const inactiveCustomers = customers.filter(c => c.status === 'Inactive').length;
          const optOutCustomers = customers.filter(c => c.status === 'Opt-Out').length;
          
          const newThisMonth = customers.filter(c => {
            const addedDate = new Date(c.addedDate);
            const now = new Date();
            return addedDate.getMonth() === now.getMonth() && addedDate.getFullYear() === now.getFullYear();
          }).length;
          
          const messageCounts = { whatsapp: 0, sms: 0, email: 0 };
          messageLog.forEach(log => {
            if (messageCounts.hasOwnProperty(log.type)) {
              messageCounts[log.type]++;
            }
          });
          
          const pendingFollowups = followups.filter(f => f.status === 'pending').length;
          const completedFollowups = followups.filter(f => f.status === 'completed').length;
          
          const pendingTasks = tasks.filter(t => t.status === 'pending').length;
          const completedTasks = tasks.filter(t => t.status === 'completed').length;
          
          // Generate report HTML
          const reportHtml = `
            <html>
              <head>
                <title>CRM Report - ${new Date().toLocaleDateString()}</title>
                <style>
                  body { font-family: Arial, sans-serif; margin: 20px; }
                  h1 { color: #667eea; }
                  h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
                  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                  th { background-color: #f2f2f2; }
                  .summary { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
                  .summary-item { background-color: #f9f9f9; padding: 15px; border-radius: 5px; min-width: 200px; }
                  .summary-item h3 { margin-top: 0; color: #667eea; }
                  .summary-item p { font-size: 24px; font-weight: bold; margin: 5px 0; }
                  .footer { margin-top: 30px; font-size: 12px; color: #888; }
                </style>
              </head>
              <body>
                <h1>CRM System Report</h1>
                <p>Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                
                <div class="summary">
                  <div class="summary-item">
                    <h3>Total Customers</h3>
                    <p>${totalCustomers}</p>
                  </div>
                  <div class="summary-item">
                    <h3>Active Customers</h3>
                    <p>${activeCustomers}</p>
                  </div>
                  <div class="summary-item">
                    <h3>New This Month</h3>
                    <p>${newThisMonth}</p>
                  </div>
                  <div class="summary-item">
                    <h3>Retention Rate</h3>
                    <p>${calculateRetentionRate()}%</p>
                  </div>
                </div>
                
                <h2>Customer Status</h2>
                <table>
                  <tr>
                    <th>Status</th>
                    <th>Count</th>
                    <th>Percentage</th>
                  </tr>
                  <tr>
                    <td>Active</td>
                    <td>${activeCustomers}</td>
                    <td>${totalCustomers > 0 ? Math.round((activeCustomers / totalCustomers) * 100) : 0}%</td>
                  </tr>
                  <tr>
                    <td>Inactive</td>
                    <td>${inactiveCustomers}</td>
                    <td>${totalCustomers > 0 ? Math.round((inactiveCustomers / totalCustomers) * 100) : 0}%</td>
                  </tr>
                  <tr>
                    <td>Opt-Out</td>
                    <td>${optOutCustomers}</td>
                    <td>${totalCustomers > 0 ? Math.round((optOutCustomers / totalCustomers) * 100) : 0}%</td>
                  </tr>
                </table>
                
                <h2>Message Statistics</h2>
                <table>
                  <tr>
                    <th>Type</th>
                    <th>Count</th>
                  </tr>
                  <tr>
                    <td>WhatsApp</td>
                    <td>${messageCounts.whatsapp}</td>
                  </tr>
                  <tr>
                    <td>SMS</td>
                    <td>${messageCounts.sms}</td>
                  </tr>
                  <tr>
                    <td>Email</td>
                    <td>${messageCounts.email}</td>
                  </tr>
                </table>
                
                <h2>Follow-ups</h2>
                <table>
                  <tr>
                    <th>Status</th>
                    <th>Count</th>
                  </tr>
                  <tr>
                    <td>Pending</td>
                    <td>${pendingFollowups}</td>
                  </tr>
                  <tr>
                    <td>Completed</td>
                    <td>${completedFollowups}</td>
                  </tr>
                </table>
                
                <h2>Tasks</h2>
                <table>
                  <tr>
                    <th>Status</th>
                    <th>Count</th>
                  </tr>
                  <tr>
                    <td>Pending</td>
                    <td>${pendingTasks}</td>
                  </tr>
                  <tr>
                    <td>Completed</td>
                    <td>${completedTasks}</td>
                  </tr>
                </table>
                
                <div class="footer">
                  <p>Generated by CRM System</p>
                </div>
              </body>
            </html>
          `;
          
          // Create and download report
          const dataUri = 'data:text/html;charset=utf-8,'+ encodeURIComponent(reportHtml);
          const exportFileDefaultName = `crm_report_${new Date().toISOString().slice(0, 10)}.html`;
          
          const linkElement = document.createElement('a');
          linkElement.setAttribute('href', dataUri);
          linkElement.setAttribute('download', exportFileDefaultName);
          linkElement.click();
          
          // Add to activity feed
          addActivity('Generated CRM report');
          
          showToast('Report generated successfully', 'success');
        } catch (error) {
          console.error('Error generating report:', error);
          showToast('Error generating report', 'error');
        } finally {
          hideLoadingOverlay();
        }
      }, 1000);
    }

    // Quick Add Customer
    function quickAddCustomer() {
      // Simple prompt for quick add - in a real app, this would be a proper form
      const name = prompt('Customer name:');
      if (!name) return;
      
      const phone = prompt('Phone number:');
      if (!phone) return;
      
      const nameParts = name.split(' ');
      const firstName = nameParts[0];
      const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';
      
      // Create customer
      const customer = {
        id: Date.now().toString(),
        firstName,
        lastName,
        phone,
        email: '',
        branch: 'Hamdan', // Default branch
        status: 'Active',
        lifecycleStage: 'LEAD',
        tags: [],
        addedDate: new Date().toISOString(),
        lastContact: new Date().toISOString()
      };
      
      customers.push(customer);
      
      // Add to activity feed
      addActivity(`Quick added customer: ${name}`);
      
      saveData();
      renderCustomers();
      updateMetrics();
      updateCharts();
      
      showToast('Customer added successfully', 'success');
    }

    // Bulk Actions
    function bulkActions() {
      if (selectedCustomers.size === 0) {
        showToast('No customers selected', 'warning');
        return;
      }
      
      // Show messaging section with selected customers
      showSection('messaging');
      document.getElementById('recipientType').value = 'selected';
      updateRecipients();
    }

    // Advanced Segmentation Functions
    function addRule() {
      const ruleBuilder = document.querySelector('.rule-builder');
      const ruleContainer = document.createElement('div');
      ruleContainer.className = 'rule-container';
      ruleContainer.innerHTML = `
        <select class="rule-field form-control-custom">
          <option value="">Select Field</option>
          <option value="firstName">First Name</option>
          <option value="lastName">Last Name</option>
          <option value="phone">Phone</option>
          <option value="email">Email</option>
          <option value="branch">Branch</option>
          <option value="status">Status</option>
          <option value="lifecycleStage">Lifecycle Stage</option>
          <option value="addedDate">Added Date</option>
          <option value="lastContact">Last Contact</option>
        </select>
        <select class="rule-operator form-control-custom">
          <option value="equals">Equals</option>
          <option value="not_equals">Not Equals</option>
          <option value="contains">Contains</option>
          <option value="not_contains">Not Contains</option>
          <option value="greater_than">Greater Than</option>
          <option value="less_than">Less Than</option>
          <option value="before">Before</option>
          <option value="after">After</option>
        </select>
        <input type="text" class="rule-value form-control-custom" placeholder="Value">
        <button type="button" class="btn btn-danger" onclick="removeRule(this)">Remove</button>
      `;
      
      ruleBuilder.insertBefore(ruleContainer, ruleBuilder.querySelector('.btn-secondary'));
    }

    function removeRule(button) {
      button.parentElement.remove();
    }

    function getSegmentRules() {
      const rules = [];
      const ruleContainers = document.querySelectorAll('.rule-container');
      
      ruleContainers.forEach(container => {
        const field = container.querySelector('.rule-field').value;
        const operator = container.querySelector('.rule-operator').value;
        const value = container.querySelector('.rule-value').value;
        
        if (field && operator && value) {
          rules.push({ field, operator, value });
        }
      });
      
      return rules;
    }

    function applyRule(customer, rule) {
      const { field, operator, value } = rule;
      const customerValue = customer[field];
      
      switch (operator) {
        case 'equals':
          return customerValue === value;
        case 'not_equals':
          return customerValue !== value;
        case 'contains':
          return customerValue && customerValue.toString().toLowerCase().includes(value.toLowerCase());
        case 'not_contains':
          return !customerValue || !customerValue.toString().toLowerCase().includes(value.toLowerCase());
        case 'greater_than':
          return parseFloat(customerValue) > parseFloat(value);
        case 'less_than':
          return parseFloat(customerValue) < parseFloat(value);
        case 'before':
          return new Date(customerValue) < new Date(value);
        case 'after':
          return new Date(customerValue) > new Date(value);
        default:
          return false;
      }
    }

    function createAdvancedSegment() {
      const segmentName = document.getElementById('segmentName').value.trim();
      const rules = getSegmentRules();
      const isDynamic = document.getElementById('dynamicSegment').checked;
      
      if (!segmentName || rules.length === 0) {
        showToast('Please provide a segment name and at least one rule', 'error');
        return;
      }
      
      // Apply rules to filter customers
      const segmentCustomers = customers.filter(customer => {
        return rules.every(rule => applyRule(customer, rule));
      });
      
      if (segmentCustomers.length === 0) {
        showToast('No customers match the specified criteria', 'warning');
        return;
      }
      
      // Create segment
      const segment = {
        id: Date.now().toString(),
        name: segmentName,
        rules: rules,
        customerIds: segmentCustomers.map(c => c.id),
        createdAt: new Date().toISOString(),
        dynamic: isDynamic
      };
      
      segments.push(segment);
      
      // Add to activity feed
      addActivity(`Created segment: ${segmentName} with ${segmentCustomers.length} customers`);
      
      // Update segment list
      renderSegments();
      updateSegmentDropdown();
      
      // Reset form
      document.getElementById('segmentName').value = '';
      
      showToast(`Segment "${segmentName}" created with ${segmentCustomers.length} customers`, 'success');
    }

    function renderSegments() {
      const segmentList = document.getElementById('segmentList');
      if (!segmentList) return;
      
      segmentList.innerHTML = '';
      
      if (segments.length === 0) {
        segmentList.innerHTML = '<p class="text-muted">No segments created yet</p>';
        return;
      }
      
      segments.forEach(segment => {
        const segmentItem = document.createElement('div');
        segmentItem.className = 'segment-item';
        segmentItem.innerHTML = `
          <div>
            <h5>${segment.name} ${segment.dynamic ? '(Dynamic)' : '(Static)'}</h5>
            <p class="mb-0">${segment.customerIds.length} customers</p>
            <small class="text-muted">Created: ${new Date(segment.createdAt).toLocaleDateString()}</small>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary" onclick="viewSegment('${segment.id}')">
              <i class="bi bi-eye"></i> View
            </button>
            <button class="btn btn-sm btn-success" onclick="messageSegment('${segment.id}')">
              <i class="bi bi-send"></i> Message
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteSegment('${segment.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;
        
        segmentList.appendChild(segmentItem);
      });
    }

    function updateSegmentDropdown() {
      const segmentSelect = document.getElementById('msgSegment');
      if (!segmentSelect) return;
      
      segmentSelect.innerHTML = '<option value="">Select Segment</option>';
      segments.forEach(segment => {
        const option = document.createElement('option');
        option.value = segment.id;
        option.textContent = `${segment.name} ${segment.dynamic ? '(Dynamic)' : '(Static)'}`;
        segmentSelect.appendChild(option);
      });
    }

    function viewSegment(segmentId) {
      const segment = segments.find(s => s.id === segmentId);
      if (!segment) return;
      
      const segmentCustomers = customers.filter(c => {
        if (segment.dynamic) {
          return segment.rules.every(rule => applyRule(c, rule));
        } else {
          return segment.customerIds.includes(c.id);
        }
      });
      
      // Select customers in segment
      selectedCustomers.clear();
      segmentCustomers.forEach(c => selectedCustomers.add(c.id));
      
      // Show customers section
      showSection('customers');
      
      showToast(`Viewing ${segmentCustomers.length} customers in segment: ${segment.name}`, 'info');
    }

    function messageSegment(segmentId) {
      const segment = segments.find(s => s.id === segmentId);
      if (!segment) return;
      
      const segmentCustomers = customers.filter(c => {
        if (segment.dynamic) {
          return segment.rules.every(rule => applyRule(c, rule));
        } else {
          return segment.customerIds.includes(c.id);
        }
      });
      
      // Select customers in segment
      selectedCustomers.clear();
      segmentCustomers.forEach(c => selectedCustomers.add(c.id));
      
      // Show messaging section
      showSection('messaging');
      document.getElementById('recipientType').value = 'selected';
      updateRecipients();
      
      showToast(`Ready to message ${segmentCustomers.length} customers in segment: ${segment.name}`, 'info');
    }

    function deleteSegment(segmentId) {
      if (!confirm('Are you sure you want to delete this segment?')) {
        return;
      }
      
      const index = segments.findIndex(s => s.id === segmentId);
      if (index !== -1) {
        const segment = segments[index];
        
        // Add to activity feed
        addActivity(`Deleted segment: ${segment.name}`);
        
        segments.splice(index, 1);
        renderSegments();
        updateSegmentDropdown();
        
        showToast('Segment deleted', 'success');
      }
    }

    // Setup PWA Integration
    function setupPWAIntegration() {
      // WhatsApp integration
      const whatsappNumber = document.getElementById('whatsappNumber');
      if (whatsappNumber) {
        whatsappNumber.addEventListener('change', function(e) {
          const phone = e.target.value;
          if (validatePhone(phone)) {
            settings.whatsappNumber = phone;
            saveData();
            showToast('WhatsApp number updated', 'success');
          } else {
            showToast('Please enter a valid phone number', 'error');
          }
        });
      }
      
      // Email integration
      const smtpServer = document.getElementById('smtpServer');
      if (smtpServer) {
        smtpServer.addEventListener('change', function(e) {
          settings.smtpServer = e.target.value;
          saveData();
          showToast('SMTP server updated', 'success');
        });
      }
    }

    // Setup Voice Commands
    function setupVoiceCommands() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        
        recognition.onresult = function(event) {
          const command = event.results[0][0].transcript.toLowerCase();
          processVoiceCommand(command);
        };
        
        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
        };
        
        // Start listening when voice indicator is clicked
        const voiceIndicator = document.getElementById('voiceIndicator');
        if (voiceIndicator) {
          voiceIndicator.addEventListener('click', function() {
            voiceIndicator.classList.add('active');
            recognition.start();
            
            setTimeout(() => {
              recognition.stop();
              voiceIndicator.classList.remove('active');
            }, 5000);
          });
        }
      }
    }

    // Process Voice Command
    function processVoiceCommand(command) {
      if (command.includes('add customer')) {
        showSection('add-customer');
        showToast('Opening add customer form', 'info');
      } else if (command.includes('send message')) {
        showSection('messaging');
        showToast('Opening messaging section', 'info');
      } else if (command.includes('dashboard')) {
        showSection('dashboard');
        showToast('Opening dashboard', 'info');
      } else if (command.includes('customers')) {
        showSection('customers');
        showToast('Opening customers section', 'info');
      } else if (command.includes('analytics')) {
        showSection('analytics');
        showToast('Opening analytics section', 'info');
      } else if (command.includes('export')) {
        showExportModal();
      } else if (command.includes('backup')) {
        backupData();
      } else if (command.includes('report')) {
        generateReport();
      } else {
        showToast(`Command not recognized: ${command}`, 'warning');
      }
    }

    // Setup Auto Save
    function setupAutoSave() {
      // Save data every 30 seconds
      setInterval(saveData, 30000);
    }

    // Show Loading Overlay
    function showLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.add('active');
      }
    }

    // Hide Loading Overlay
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.remove('active');
      }
    }

    // Show Toast Notification
    function showToast(message, type = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      if (!toastContainer) return;
      
      const toastId = 'toast-' + Date.now();
      const toastHtml = `
        <div id="${toastId}" class="toast custom-toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'primary'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 3000
      });
      
      toast.show();
      
      // Remove toast element after it's hidden
      toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
      });
    }

    // Update Element
    function updateElement(id, value) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value;
      }
    }

    // Debug Function
    function debug(message) {
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        debugInfo.textContent = message;
      }
      console.log(message);
    }
  </script>
</body>
</html>
