<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced Customer Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #28a745, #20c997);
      --warning-gradient: linear-gradient(135deg, #ffc107, #ff9800);
      --danger-gradient: linear-gradient(135deg, #dc3545, #fd7e14);
      --info-gradient: linear-gradient(135deg, #17a2b8, #6c757d);
      --dark-gradient: linear-gradient(135deg, #343a40, #495057);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }

    /* Sidebar Navigation */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 250px;
      background: var(--dark-gradient);
      color: white;
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .sidebar.collapsed {
      transform: translateX(-250px);
    }

    .sidebar-header {
      padding: 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
    }

    .sidebar-menu li {
      margin-bottom: 10px;
    }

    .sidebar-menu a {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      padding: 12px 15px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      transition: all 0.3s;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .sidebar-menu i {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    /* Main Content */
    .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    .main-content.expanded {
      margin-left: 0;
    }

    /* Header */
    .header {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }

    .header-top {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 20px;
    }

    .menu-toggle {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 15px;
      margin-right: 15px;
      cursor: pointer;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 2.5rem;
      opacity: 0.1;
      color: #667eea;
    }

    /* Content Cards */
    .content-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }

    .card-header-custom {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    /* Forms */
    .form-floating-custom {
      position: relative;
      margin-bottom: 20px;
    }

    .form-control-custom {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .form-control-custom:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    /* Buttons */
    .btn-gradient {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 25px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .btn-success-gradient {
      background: var(--success-gradient);
    }

    .btn-danger-gradient {
      background: var(--danger-gradient);
    }

    /* Data Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table thead {
      background: var(--primary-gradient);
      color: white;
    }

    .data-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 1px;
    }

    .data-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .data-table tbody tr {
      transition: all 0.2s;
    }

    .data-table tbody tr:hover {
      background: #f8f9fa;
    }

    /* Status Badges */
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-active {
      background: var(--success-gradient);
      color: white;
    }

    .status-inactive {
      background: var(--warning-gradient);
      color: white;
    }

    .status-optout {
      background: var(--danger-gradient);
      color: white;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn-action {
      padding: 5px 10px;
      border-radius: 5px;
      border: none;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .btn-action:hover {
      transform: scale(1.1);
    }

    /* Import/Export Section */
    .import-export-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .file-upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }

    .file-upload-area:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .file-upload-area.dragover {
      border-color: #667eea;
      background: #e7f3ff;
    }

    /* Advanced Filters */
    .filter-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .filter-group {
      margin-bottom: 15px;
    }

    .filter-label {
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }

    /* Modal Customizations */
    .modal-content {
      border-radius: 20px;
      border: none;
    }

    .modal-header {
      background: var(--primary-gradient);
      color: white;
      border-radius: 20px 20px 0 0;
      border: none;
    }

    .modal-header .btn-close {
      filter: brightness(0) invert(1);
    }

    /* Loading Spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-overlay.active {
      display: flex;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .custom-toast {
      min-width: 300px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-250px);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .quick-action-btn {
      padding: 10px 20px;
      border-radius: 10px;
      border: 2px solid #e9ecef;
      background: white;
      transition: all 0.3s;
      cursor: pointer;
    }

    .quick-action-btn:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .quick-action-btn.active {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    /* Data Validation */
    .is-invalid {
      border-color: #dc3545 !important;
    }

    .invalid-feedback {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    /* Bulk Operations */
    .bulk-actions {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }

    .bulk-actions.active {
      display: block;
    }

    /* Customer Tags */
    .customer-tags {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-top: 5px;
    }

    .tag {
      padding: 3px 8px;
      background: #e9ecef;
      border-radius: 5px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .tag.premium {
      background: var(--warning-gradient);
      color: white;
    }

    .tag.vip {
      background: var(--primary-gradient);
      color: white;
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h4><i class="bi bi-people-fill me-2"></i>CRM System</h4>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" class="active" onclick="showSection('dashboard')"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
      <li><a href="#" onclick="showSection('customers')"><i class="bi bi-people"></i> Customers</a></li>
      <li><a href="#" onclick="showSection('add-customer')"><i class="bi bi-person-plus"></i> Add Customer</a></li>
      <li><a href="#" onclick="showSection('bulk-import')"><i class="bi bi-upload"></i> Bulk Import</a></li>
      <li><a href="#" onclick="showSection('messaging')"><i class="bi bi-chat-dots"></i> Messaging</a></li>
      <li><a href="#" onclick="showSection('analytics')"><i class="bi bi-graph-up"></i> Analytics</a></li>
      <li><a href="#" onclick="showSection('settings')"><i class="bi bi-gear"></i> Settings</a></li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <!-- Header -->
    <div class="header">
      <div class="header-top">
        <div style="display: flex; align-items: center;">
          <button class="menu-toggle" onclick="toggleSidebar()">
            <i class="bi bi-list"></i>
          </button>
          <h2 class="mb-0">Customer Management System</h2>
        </div>
        <div>
          <button class="btn btn-gradient me-2" onclick="exportData()">
            <i class="bi bi-download me-2"></i>Export
          </button>
          <button class="btn btn-success-gradient" onclick="quickAddCustomer()">
            <i class="bi bi-plus-circle me-2"></i>Quick Add
          </button>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="section">
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalCustomers">0</div>
          <div class="stat-label">Total Customers</div>
          <i class="bi bi-people stat-icon"></i>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeCustomers">0</div>
          <div class="stat-label">Active</div>
          <i class="bi bi-person-check stat-icon"></i>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="newThisMonth">0</div>
          <div class="stat-label">New This Month</div>
          <i class="bi bi-calendar-plus stat-icon"></i>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="messagesSent">0</div>
          <div class="stat-label">Messages Sent</div>
          <i class="bi bi-send stat-icon"></i>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="content-card">
        <h4 class="mb-3">Quick Actions</h4>
        <div class="quick-actions">
          <button class="quick-action-btn" onclick="showSection('add-customer')">
            <i class="bi bi-person-plus me-2"></i>Add Customer
          </button>
          <button class="quick-action-btn" onclick="showSection('bulk-import')">
            <i class="bi bi-upload me-2"></i>Import CSV
          </button>
          <button class="quick-action-btn" onclick="showSection('messaging')">
            <i class="bi bi-chat-dots me-2"></i>Send Message
          </button>
          <button class="quick-action-btn" onclick="generateReport()">
            <i class="bi bi-file-earmark-text me-2"></i>Generate Report
          </button>
          <button class="quick-action-btn" onclick="backupData()">
            <i class="bi bi-cloud-download me-2"></i>Backup Data
          </button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="content-card">
        <h4 class="mb-3">Recent Activity</h4>
        <div id="recentActivity">
          <p class="text-muted">No recent activity</p>
        </div>
      </div>
    </div>

    <!-- Customers Section -->
    <div id="customers-section" class="section" style="display: none;">
      <!-- Advanced Filters -->
      <div class="filter-section">
        <h5 class="mb-3">Filters</h5>
        <div class="row">
          <div class="col-md-3">
            <div class="filter-group">
              <label class="filter-label">Status</label>
              <select class="form-control-custom" id="filterStatus" onchange="applyFilters()">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
                <option value="Opt-Out">Opt-Out</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="filter-group">
              <label class="filter-label">Branch</label>
              <select class="form-control-custom" id="filterBranch" onchange="applyFilters()">
                <option value="">All Branches</option>
                <option value="Hamdan">Hamdan</option>
                <option value="Muroor">Muroor</option>
                <option value="Shabiya 11">Shabiya 11</option>
                <option value="Al Barsha">Al Barsha</option>
                <option value="Al Rigga">Al Rigga</option>
                <option value="Khalidiya">Khalidiya</option>
                <option value="Al Satwa">Al Satwa</option>
              </select>
            </div>
          </div>
          <div class="col-md-3">
            <div class="filter-group">
              <label class="filter-label">Date Added</label>
              <input type="date" class="form-control-custom" id="filterDate" onchange="applyFilters()">
            </div>
          </div>
          <div class="col-md-3">
            <div class="filter-group">
              <label class="filter-label">Search</label>
              <input type="text" class="form-control-custom" id="searchCustomers" placeholder="Search..." onkeyup="applyFilters()">
            </div>
          </div>
        </div>
      </div>

      <!-- Bulk Actions -->
      <div class="bulk-actions" id="bulkActions">
        <div class="d-flex justify-content-between align-items-center">
          <span id="selectedCount">0 customers selected</span>
          <div>
            <button class="btn btn-gradient me-2" onclick="bulkMessage()">
              <i class="bi bi-send me-1"></i>Send Message
            </button>
            <button class="btn btn-danger-gradient" onclick="bulkDelete()">
              <i class="bi bi-trash me-1"></i>Delete
            </button>
          </div>
        </div>
      </div>

      <!-- Customers Table -->
      <div class="content-card">
        <div class="card-header-custom">
          <h4 class="mb-0">Customer List</h4>
          <div>
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            <label for="selectAll">Select All</label>
          </div>
        </div>
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="headerCheckbox" onchange="toggleSelectAll()"></th>
                <th onclick="sortTable('name')">Name <i class="bi bi-arrow-down-up"></i></th>
                <th onclick="sortTable('phone')">Phone <i class="bi bi-arrow-down-up"></i></th>
                <th onclick="sortTable('email')">Email <i class="bi bi-arrow-down-up"></i></th>
                <th onclick="sortTable('branch')">Branch <i class="bi bi-arrow-down-up"></i></th>
                <th onclick="sortTable('status')">Status <i class="bi bi-arrow-down-up"></i></th>
                <th onclick="sortTable('addedDate')">Added <i class="bi bi-arrow-down-up"></i></th>
                <th>Tags</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTableBody">
              <!-- Table rows will be dynamically added -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add Customer Section -->
    <div id="add-customer-section" class="section" style="display: none;">
      <div class="content-card">
        <h4 class="mb-4">Add New Customer</h4>
        <form id="addCustomerForm">
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="filter-label">First Name *</label>
                <input type="text" class="form-control-custom" id="firstName" required>
                <div class="invalid-feedback">Please enter first name</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="filter-label">Last Name</label>
                <input type="text" class="form-control-custom" id="lastName">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="filter-label">Phone Number *</label>
                <input type="tel" class="form-control-custom" id="phoneNumber" required>
                <div class="invalid-feedback">Please enter a valid phone number</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="filter-label">Email</label>
                <input type="email" class="form-control-custom" id="email">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="filter-label">Branch *</label>
                <select class="form-control-custom" id="branch" required>
                  <option value="">Select Branch</option>
                  <option value="Hamdan">Hamdan</option>
                  <option value="Muroor">Muroor</option>
                  <option value="Shabiya 11">Shabiya 11</option>
                  <option value="Al Barsha">Al Barsha</option>
                  <option value="Al Rigga">Al Rigga</option>
                  <option value="Khalidiya">Khalidiya</option>
                  <option value="Al Satwa">Al Satwa</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="filter-label">Status</label>
                <select class="form-control-custom" id="status">
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="filter-label">Date of Birth</label>
                <input type="date" class="form-control-custom" id="dob">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating-custom">
                <label class="filter-label">Anniversary</label>
                <input type="date" class="form-control-custom" id="anniversary">
              </div>
            </div>
          </div>
          <div class="form-floating-custom">
            <label class="filter-label">Address</label>
            <textarea class="form-control-custom" id="address" rows="3"></textarea>
          </div>
          <div class="form-floating-custom">
            <label class="filter-label">Notes</label>
            <textarea class="form-control-custom" id="notes" rows="3"></textarea>
          </div>
          <div class="form-floating-custom">
            <label class="filter-label">Tags (comma separated)</label>
            <input type="text" class="form-control-custom" id="tags" placeholder="e.g., VIP, Premium, Regular">
          </div>
          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-gradient">
              <i class="bi bi-save me-2"></i>Save Customer
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
              <i class="bi bi-arrow-clockwise me-2"></i>Reset
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bulk Import Section -->
    <div id="bulk-import-section" class="section" style="display: none;">
      <div class="content-card">
        <h4 class="mb-4">Bulk Import Customers</h4>
        
        <!-- Download Template -->
        <div class="import-export-section">
          <h5>Step 1: Download Template</h5>
          <p>Download our CSV template and fill it with your customer data.</p>
          <button class="btn btn-gradient" onclick="downloadTemplate()">
            <i class="bi bi-download me-2"></i>Download CSV Template
          </button>
        </div>

        <!-- Upload File -->
        <div class="import-export-section">
          <h5>Step 2: Upload File</h5>
          <div class="file-upload-area" id="fileUploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #667eea;"></i>
            <p class="mt-3">Drag and drop your CSV file here or click to browse</p>
            <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
            <button class="btn btn-gradient mt-2" onclick="document.getElementById('csvFile').click()">
              Choose File
            </button>
          </div>
          <div id="fileInfo" class="mt-3" style="display: none;">
            <p><strong>Selected file:</strong> <span id="fileName"></span></p>
            <button class="btn btn-success-gradient" onclick="processCSV()">
              <i class="bi bi-upload me-2"></i>Import Data
            </button>
          </div>
        </div>

        <!-- Import Preview -->
        <div id="importPreview" style="display: none;">
          <h5>Step 3: Preview & Confirm</h5>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Email</th>
                  <th>Branch</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="previewTableBody">
                <!-- Preview rows will be added here -->
              </tbody>
            </table>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-success-gradient" onclick="confirmImport()">
              <i class="bi bi-check-circle me-2"></i>Confirm Import
            </button>
            <button class="btn btn-secondary" onclick="cancelImport()">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Messaging Section -->
    <div id="messaging-section" class="section" style="display: none;">
      <div class="content-card">
        <h4 class="mb-4">Send Messages</h4>
        
        <!-- Message Type Selection -->
        <div class="row mb-4">
          <div class="col-md-12">
            <label class="filter-label">Message Type</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="msgType" id="msgWhatsApp" value="whatsapp" checked>
              <label class="btn btn-outline-success" for="msgWhatsApp">
                <i class="bi bi-whatsapp me-2"></i>WhatsApp
              </label>
              <input type="radio" class="btn-check" name="msgType" id="msgSMS" value="sms">
              <label class="btn btn-outline-primary" for="msgSMS">
                <i class="bi bi-chat-dots me-2"></i>SMS
              </label>
              <input type="radio" class="btn-check" name="msgType" id="msgEmail" value="email">
              <label class="btn btn-outline-info" for="msgEmail">
                <i class="bi bi-envelope me-2"></i>Email
              </label>
            </div>
          </div>
        </div>

        <!-- Recipients Selection -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label class="filter-label">Select Recipients</label>
            <select class="form-control-custom" id="recipientType" onchange="updateRecipients()">
              <option value="all">All Active Customers</option>
              <option value="branch">By Branch</option>
              <option value="tags">By Tags</option>
              <option value="custom">Custom Selection</option>
            </select>
          </div>
          <div class="col-md-6" id="branchSelection" style="display: none;">
            <label class="filter-label">Select Branch</label>
            <select class="form-control-custom" id="msgBranch" onchange="updateRecipients()">
              <option value="Hamdan">Hamdan</option>
              <option value="Muroor">Muroor</option>
              <option value="Shabiya 11">Shabiya 11</option>
              <option value="Al Barsha">Al Barsha</option>
              <option value="Al Rigga">Al Rigga</option>
              <option value="Khalidiya">Khalidiya</option>
              <option value="Al Satwa">Al Satwa</option>
            </select>
          </div>
        </div>

        <!-- Message Templates -->
        <div class="mb-4">
          <label class="filter-label">Message Template</label>
          <div class="row">
            <div class="col-md-3">
              <div class="form-floating-custom">
                <select class="form-control-custom" id="msgTemplate" onchange="loadTemplate()">
                  <option value="">Select Template</option>
                  <option value="welcome">Welcome Message</option>
                  <option value="promotion">Special Promotion</option>
                  <option value="reminder">Appointment Reminder</option>
                  <option value="feedback">Feedback Request</option>
                  <option value="custom">Custom Message</option>
                </select>
              </div>
            </div>
            <div class="col-md-9">
              <div class="form-floating-custom">
                <textarea class="form-control-custom" id="msgText" rows="4" placeholder="Type your message here..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Recipients Preview -->
        <div class="mb-4">
          <label class="filter-label">Recipients (<span id="recipientCount">0</span>)</label>
          <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
            <div id="recipientsList"></div>
          </div>
        </div>

        <!-- Send Button -->
        <button class="btn btn-success-gradient btn-lg" onclick="sendMessages()">
          <i class="bi bi-send me-2"></i>Send Messages
        </button>
      </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics-section" class="section" style="display: none;">
      <div class="content-card">
        <h4 class="mb-4">Analytics Dashboard</h4>
        
        <!-- Chart Containers -->
        <div class="row">
          <div class="col-md-6">
            <div class="chart-container">
              <canvas id="customerGrowthChart"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-container">
              <canvas id="branchDistributionChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="chart-container">
              <canvas id="messageStatsChart"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-container">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div id="settings-section" class="section" style="display: none;">
      <div class="content-card">
        <h4 class="mb-4">Settings</h4>
        
        <!-- General Settings -->
        <div class="mb-4">
          <h5>General Settings</h5>
          <div class="form-floating-custom">
            <label class="filter-label">Company Name</label>
            <input type="text" class="form-control-custom" id="companyName" value="Your Company">
          </div>
          <div class="form-floating-custom">
            <label class="filter-label">Company Phone</label>
            <input type="tel" class="form-control-custom" id="companyPhone" value="+971501882206">
          </div>
          <div class="form-floating-custom">
            <label class="filter-label">Company Email</label>
            <input type="email" class="form-control-custom" id="companyEmail" value="info@company.com">
          </div>
        </div>

        <!-- Message Settings -->
        <div class="mb-4">
          <h5>Message Settings</h5>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="enableRateLimit" checked>
            <label class="form-check-label" for="enableRateLimit">
              Enable rate limiting (1 message per customer per day)
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="enableDeliveryReport" checked>
            <label class="form-check-label" for="enableDeliveryReport">
              Enable delivery reports
            </label>
          </div>
        </div>

        <!-- Data Management -->
        <div class="mb-4">
          <h5>Data Management</h5>
          <button class="btn btn-gradient me-2" onclick="backupData()">
            <i class="bi bi-cloud-download me-2"></i>Backup All Data
          </button>
          <button class="btn btn-danger-gradient" onclick="clearAllData()">
            <i class="bi bi-trash me-2"></i>Clear All Data
          </button>
        </div>

        <button class="btn btn-success-gradient" onclick="saveSettings()">
          <i class="bi bi-save me-2"></i>Save Settings
        </button>
      </div>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Processing...</p>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <!-- Edit Customer Modal -->
  <div class="modal fade" id="editCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editCustomerForm">
            <input type="hidden" id="editCustomerId">
            <!-- Form fields will be populated dynamically -->
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-gradient" onclick="saveEditedCustomer()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Application State
    let customers = [];
    let messageLog = [];
    let settings = {
      companyName: 'Your Company',
      companyPhone: '+971501882206',
      companyEmail: 'info@company.com',
      enableRateLimit: true,
      enableDeliveryReport: true
    };
    let selectedCustomers = new Set();
    let currentSection = 'dashboard';
    let sortColumn = 'addedDate';
    let sortDirection = 'desc';
    let csvData = [];

    // Initialize Application
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      showSection('dashboard');
      updateMetrics();
      renderCustomers();
      initCharts();
    });

    // Load Data from LocalStorage
    function loadData() {
      const storedCustomers = localStorage.getItem('customers');
      const storedMessageLog = localStorage.getItem('messageLog');
      const storedSettings = localStorage.getItem('settings');

      if (storedCustomers) {
        customers = JSON.parse(storedCustomers);
      } else {
        // Initialize with sample data
        initializeSampleData();
      }

      if (storedMessageLog) {
        messageLog = JSON.parse(storedMessageLog);
      }

      if (storedSettings) {
        settings = JSON.parse(storedSettings);
      }
    }

    // Initialize Sample Data
    function initializeSampleData() {
      const sampleData = [
        { branch: 'Hamdan', mobile: '564394125', name: 'CHRISTINE JOY', email: 'christine@email.com' },
        { branch: 'Muroor', mobile: '527186938', name: 'REN ALVAREZ', email: 'ren@email.com' },
        { branch: 'Shabiya 11', mobile: '501320863', name: 'FARDUS KHAN', email: 'fardus@email.com' },
        { branch: 'Shabiya 11', mobile: '504007898', name: 'JUMANA SAEED', email: 'jumana@email.com' },
        { branch: 'Al Barsha', mobile: '567578678', name: 'CAMILLE SANTOS', email: 'camille@email.com' }
      ];

      customers = sampleData.map((item, index) => ({
        id: Date.now() + index,
        firstName: item.name.split(' ')[0],
        lastName: item.name.split(' ')[1] || '',
        phone: `+971${item.mobile}`,
        email: item.email,
        branch: item.branch,
        status: 'Active',
        addedDate: new Date().toISOString(),
        dob: '',
        anniversary: '',
        address: '',
        notes: '',
        tags: ['Regular']
      }));

      saveData();
    }

    // Save Data to LocalStorage
    function saveData() {
      localStorage.setItem('customers', JSON.stringify(customers));
      localStorage.setItem('messageLog', JSON.stringify(messageLog));
      localStorage.setItem('settings', JSON.stringify(settings));
    }

    // Show Section
    function showSection(section) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(s => {
        s.style.display = 'none';
      });

      // Show selected section
      document.getElementById(`${section}-section`).style.display = 'block';

      // Update sidebar active state
      document.querySelectorAll('.sidebar-menu a').forEach(a => {
        a.classList.remove('active');
      });
      event.target.classList.add('active');

      currentSection = section;

      // Section-specific initialization
      if (section === 'customers') {
        renderCustomers();
      } else if (section === 'analytics') {
        updateCharts();
      }
    }

    // Toggle Sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      
      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('expanded');
    }

    // Update Metrics
    function updateMetrics() {
      const total = customers.length;
      const active = customers.filter(c => c.status === 'Active').length;
      const thisMonth = customers.filter(c => {
        const addedDate = new Date(c.addedDate);
        const now = new Date();
        return addedDate.getMonth() === now.getMonth() && addedDate.getFullYear() === now.getFullYear();
      }).length;
      const messagesSent = messageLog.length;

      document.getElementById('totalCustomers').textContent = total;
      document.getElementById('activeCustomers').textContent = active;
      document.getElementById('newThisMonth').textContent = thisMonth;
      document.getElementById('messagesSent').textContent = messagesSent;
    }

    // Render Customers Table
    function renderCustomers() {
      const tbody = document.getElementById('customersTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';

      let filtered = [...customers];

      // Apply filters
      const statusFilter = document.getElementById('filterStatus')?.value;
      const branchFilter = document.getElementById('filterBranch')?.value;
      const searchFilter = document.getElementById('searchCustomers')?.value.toLowerCase();

      if (statusFilter) {
        filtered = filtered.filter(c => c.status === statusFilter);
      }
      if (branchFilter) {
        filtered = filtered.filter(c => c.branch === branchFilter);
      }
      if (searchFilter) {
        filtered = filtered.filter(c => 
          (c.firstName && c.firstName.toLowerCase().includes(searchFilter)) ||
          (c.lastName && c.lastName.toLowerCase().includes(searchFilter)) ||
          c.phone.includes(searchFilter) ||
          (c.email && c.email.toLowerCase().includes(searchFilter))
        );
      }

      // Sort
      filtered.sort((a, b) => {
        let aVal = a[sortColumn] || '';
        let bVal = b[sortColumn] || '';
        
        if (sortColumn === 'addedDate') {
          aVal = new Date(aVal);
          bVal = new Date(bVal);
        }
        
        if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });

      filtered.forEach(customer => {
        const tr = document.createElement('tr');
        const fullName = `${customer.firstName || ''} ${customer.lastName || ''}`.trim();
        
        tr.innerHTML = `
          <td>
            <input type="checkbox" class="customer-checkbox" data-id="${customer.id}" onchange="toggleCustomerSelection('${customer.id}')">
          </td>
          <td>${fullName || '-'}</td>
          <td>${customer.phone}</td>
          <td>${customer.email || '-'}</td>
          <td>${customer.branch}</td>
          <td>
            <span class="status-badge status-${customer.status.toLowerCase()}">${customer.status}</span>
          </td>
          <td>${new Date(customer.addedDate).toLocaleDateString()}</td>
          <td>
            <div class="customer-tags">
              ${customer.tags ? customer.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-action btn-primary" onclick="editCustomer('${customer.id}')" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn-action btn-success" onclick="quickMessage('${customer.id}')" title="Send Message">
                <i class="bi bi-send"></i>
              </button>
              <button class="btn-action btn-danger" onclick="deleteCustomer('${customer.id}')" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      updateBulkActions();
    }

    // Sort Table
    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      renderCustomers();
    }

    // Toggle Customer Selection
    function toggleCustomerSelection(customerId) {
      if (selectedCustomers.has(customerId)) {
        selectedCustomers.delete(customerId);
      } else {
        selectedCustomers.add(customerId);
      }
      updateBulkActions();
    }

    // Toggle Select All
    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('.customer-checkbox');
      const selectAll = document.getElementById('selectAll').checked || document.getElementById('headerCheckbox').checked;
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const customerId = checkbox.dataset.id;
        if (selectAll) {
          selectedCustomers.add(customerId);
        } else {
          selectedCustomers.delete(customerId);
        }
      });
      
      updateBulkActions();
    }

    // Update Bulk Actions
    function updateBulkActions() {
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      
      if (selectedCustomers.size > 0) {
        bulkActions.classList.add('active');
        selectedCount.textContent = `${selectedCustomers.size} customers selected`;
      } else {
        bulkActions.classList.remove('active');
      }
    }

    // Add Customer Form Submit
    document.getElementById('addCustomerForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const phone = document.getElementById('phoneNumber').value.trim();
      const email = document.getElementById('email').value.trim();
      const branch = document.getElementById('branch').value;
      const status = document.getElementById('status').value;
      const dob = document.getElementById('dob').value;
      const anniversary = document.getElementById('anniversary').value;
      const address = document.getElementById('address').value.trim();
      const notes = document.getElementById('notes').value.trim();
      const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);

      if (!firstName || !phone || !branch) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      const newCustomer = {
        id: Date.now().toString(),
        firstName,
        lastName,
        phone,
        email,
        branch,
        status,
        dob,
        anniversary,
        address,
        notes,
        tags,
        addedDate: new Date().toISOString()
      };

      customers.push(newCustomer);
      saveData();
      
      showToast('Customer added successfully!', 'success');
      this.reset();
      
      if (currentSection === 'customers') {
        renderCustomers();
      }
      updateMetrics();
    });

    // Edit Customer
    function editCustomer(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      // Populate edit form
      document.getElementById('editCustomerId').value = customer.id;
      
      const form = document.getElementById('editCustomerForm');
      form.innerHTML = `
        <input type="hidden" id="editCustomerId" value="${customer.id}">
        <div class="row">
          <div class="col-md-6">
            <div class="form-floating-custom">
              <label class="filter-label">First Name *</label>
              <input type="text" class="form-control-custom" id="editFirstName" value="${customer.firstName || ''}" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating-custom">
              <label class="filter-label">Last Name</label>
              <input type="text" class="form-control-custom" id="editLastName" value="${customer.lastName || ''}">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-floating-custom">
              <label class="filter-label">Phone Number *</label>
              <input type="tel" class="form-control-custom" id="editPhone" value="${customer.phone}" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating-custom">
              <label class="filter-label">Email</label>
              <input type="email" class="form-control-custom" id="editEmail" value="${customer.email || ''}">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-floating-custom">
              <label class="filter-label">Branch *</label>
              <select class="form-control-custom" id="editBranch" required>
                <option value="Hamdan" ${customer.branch === 'Hamdan' ? 'selected' : ''}>Hamdan</option>
                <option value="Muroor" ${customer.branch === 'Muroor' ? 'selected' : ''}>Muroor</option>
                <option value="Shabiya 11" ${customer.branch === 'Shabiya 11' ? 'selected' : ''}>Shabiya 11</option>
                <option value="Al Barsha" ${customer.branch === 'Al Barsha' ? 'selected' : ''}>Al Barsha</option>
                <option value="Al Rigga" ${customer.branch === 'Al Rigga' ? 'selected' : ''}>Al Rigga</option>
                <option value="Khalidiya" ${customer.branch === 'Khalidiya' ? 'selected' : ''}>Khalidiya</option>
                <option value="Al Satwa" ${customer.branch === 'Al Satwa' ? 'selected' : ''}>Al Satwa</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating-custom">
              <label class="filter-label">Status</label>
              <select class="form-control-custom" id="editStatus">
                <option value="Active" ${customer.status === 'Active' ? 'selected' : ''}>Active</option>
                <option value="Inactive" ${customer.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                <option value="Opt-Out" ${customer.status === 'Opt-Out' ? 'selected' : ''}>Opt-Out</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-floating-custom">
              <label class="filter-label">Date of Birth</label>
              <input type="date" class="form-control-custom" id="editDob" value="${customer.dob || ''}">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating-custom">
              <label class="filter-label">Anniversary</label>
              <input type="date" class="form-control-custom" id="editAnniversary" value="${customer.anniversary || ''}">
            </div>
          </div>
        </div>
        <div class="form-floating-custom">
          <label class="filter-label">Address</label>
          <textarea class="form-control-custom" id="editAddress" rows="3">${customer.address || ''}</textarea>
        </div>
        <div class="form-floating-custom">
          <label class="filter-label">Notes</label>
          <textarea class="form-control-custom" id="editNotes" rows="3">${customer.notes || ''}</textarea>
        </div>
        <div class="form-floating-custom">
          <label class="filter-label">Tags (comma separated)</label>
          <input type="text" class="form-control-custom" id="editTags" value="${customer.tags ? customer.tags.join(', ') : ''}">
        </div>
      `;

      const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
      modal.show();
    }

    // Save Edited Customer
    function saveEditedCustomer() {
      const customerId = document.getElementById('editCustomerId').value;
      const customer = customers.find(c => c.id === customerId);
      
      if (!customer) return;

      customer.firstName = document.getElementById('editFirstName').value.trim();
      customer.lastName = document.getElementById('editLastName').value.trim();
      customer.phone = document.getElementById('editPhone').value.trim();
      customer.email = document.getElementById('editEmail').value.trim();
      customer.branch = document.getElementById('editBranch').value;
      customer.status = document.getElementById('editStatus').value;
      customer.dob = document.getElementById('editDob').value;
      customer.anniversary = document.getElementById('editAnniversary').value;
      customer.address = document.getElementById('editAddress').value.trim();
      customer.notes = document.getElementById('editNotes').value.trim();
      customer.tags = document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(t => t);

      saveData();
      renderCustomers();
      updateMetrics();
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
      modal.hide();
      
      showToast('Customer updated successfully!', 'success');
    }

    // Delete Customer
    function deleteCustomer(customerId) {
      if (confirm('Are you sure you want to delete this customer?')) {
        customers = customers.filter(c => c.id !== customerId);
        saveData();
        renderCustomers();
        updateMetrics();
        showToast('Customer deleted successfully!', 'success');
      }
    }

    // Quick Add Customer
    function quickAddCustomer() {
      showSection('add-customer');
    }

    // Apply Filters
    function applyFilters() {
      renderCustomers();
    }

    // Bulk Message
    function bulkMessage() {
      if (selectedCustomers.size === 0) {
        showToast('Please select customers first', 'warning');
        return;
      }
      showSection('messaging');
    }

    // Bulk Delete
    function bulkDelete() {
      if (selectedCustomers.size === 0) {
        showToast('Please select customers first', 'warning');
        return;
      }
      
      if (confirm(`Are you sure you want to delete ${selectedCustomers.size} customers?`)) {
        customers = customers.filter(c => !selectedCustomers.has(c.id));
        selectedCustomers.clear();
        saveData();
        renderCustomers();
        updateMetrics();
        showToast('Customers deleted successfully!', 'success');
      }
    }

    // CSV Template Download
    function downloadTemplate() {
      const csvContent = `FirstName,LastName,Phone,Email,Branch,Status,DOB,Anniversary,Address,Notes,Tags
John,Doe,+971501234567,john@email.com,Hamdan,Active,1990-01-01,2020-01-01,"123 Main St","Regular customer","Regular"
Jane,Smith,+971507654321,jane@email.com,Muroor,Active,1985-05-15,2018-06-20,"456 Oak Ave","VIP customer","VIP,Premium"`;
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'customer_template.csv';
      a.click();
      
      showToast('Template downloaded successfully!', 'success');
    }

    // File Upload Handlers
    function handleDragOver(e) {
      e.preventDefault();
      document.getElementById('fileUploadArea').classList.add('dragover');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      document.getElementById('fileUploadArea').classList.remove('dragover');
    }

    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('fileUploadArea').classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelect({ target: { files } });
      }
    }

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file && file.type === 'text/csv') {
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileInfo').style.display = 'block';
        
        const reader = new FileReader();
        reader.onload = function(e) {
          csvData = parseCSV(e.target.result);
        };
        reader.readAsText(file);
      } else {
        showToast('Please select a valid CSV file', 'error');
      }
    }

    // Parse CSV
    function parseCSV(csvText) {
      const lines = csvText.split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
          const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] || '';
          });
          data.push(row);
        }
      }
      
      return data;
    }

    // Process CSV
    function processCSV() {
      if (csvData.length === 0) {
        showToast('No data to process', 'error');
        return;
      }
      
      // Show preview
      const previewBody = document.getElementById('previewTableBody');
      previewBody.innerHTML = '';
      
      csvData.slice(0, 5).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.FirstName || ''} ${row.LastName || ''}</td>
          <td>${row.Phone || ''}</td>
          <td>${row.Email || ''}</td>
          <td>${row.Branch || ''}</td>
          <td>${row.Status || 'Active'}</td>
        `;
        previewBody.appendChild(tr);
      });
      
      document.getElementById('importPreview').style.display = 'block';
      showToast(`Previewing ${csvData.length} records`, 'info');
    }

    // Confirm Import
    function confirmImport() {
      showLoading();
      
      let imported = 0;
      let skipped = 0;
      
      csvData.forEach(row => {
        // Check if phone already exists
        if (!customers.find(c => c.phone === row.Phone)) {
          const newCustomer = {
            id: Date.now().toString() + Math.random(),
            firstName: row.FirstName || '',
            lastName: row.LastName || '',
            phone: row.Phone || '',
            email: row.Email || '',
            branch: row.Branch || 'Hamdan',
            status: row.Status || 'Active',
            dob: row.DOB || '',
            anniversary: row.Anniversary || '',
            address: row.Address || '',
            notes: row.Notes || '',
            tags: row.Tags ? row.Tags.split(';').map(t => t.trim()).filter(t => t) : [],
            addedDate: new Date().toISOString()
          };
          
          customers.push(newCustomer);
          imported++;
        } else {
          skipped++;
        }
      });
      
      saveData();
      hideLoading();
      
      document.getElementById('importPreview').style.display = 'none';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('csvFile').value = '';
      
      showToast(`Import completed! ${imported} imported, ${skipped} skipped`, 'success');
      updateMetrics();
      
      if (currentSection === 'customers') {
        renderCustomers();
      }
    }

    // Cancel Import
    function cancelImport() {
      document.getElementById('importPreview').style.display = 'none';
      csvData = [];
    }

    // Update Recipients for Messaging
    function updateRecipients() {
      const type = document.getElementById('recipientType').value;
      const branchSelection = document.getElementById('branchSelection');
      const recipientsList = document.getElementById('recipientsList');
      const recipientCount = document.getElementById('recipientCount');
      
      let recipients = [];
      
      if (type === 'all') {
        recipients = customers.filter(c => c.status === 'Active');
        branchSelection.style.display = 'none';
      } else if (type === 'branch') {
        const branch = document.getElementById('msgBranch').value;
        recipients = customers.filter(c => c.status === 'Active' && c.branch === branch);
        branchSelection.style.display = 'block';
      } else {
        recipients = [];
        branchSelection.style.display = 'none';
      }
      
      // Display recipients
      recipientsList.innerHTML = recipients.map(c => 
        `<div class="mb-1">${c.firstName} ${c.lastName} (${c.phone})</div>`
      ).join('');
      
      recipientCount.textContent = recipients.length;
    }

    // Load Message Template
    function loadTemplate() {
      const template = document.getElementById('msgTemplate').value;
      const templates = {
        welcome: 'Welcome to our service! We\'re excited to have you with us.',
        promotion: 'Special offer just for you! Get 20% off on your next order.',
        reminder: 'This is a reminder for your upcoming appointment.',
        feedback: 'We value your feedback! Please rate your experience.',
        custom: ''
      };
      
      document.getElementById('msgText').value = templates[template] || '';
    }

    // Send Messages
    function sendMessages() {
      const messageText = document.getElementById('msgText').value.trim();
      const messageType = document.querySelector('input[name="msgType"]:checked').value;
      
      if (!messageText) {
        showToast('Please enter a message', 'error');
        return;
      }
      
      const recipientType = document.getElementById('recipientType').value;
      let recipients = [];
      
      if (recipientType === 'all') {
        recipients = customers.filter(c => c.status === 'Active');
      } else if (recipientType === 'branch') {
        const branch = document.getElementById('msgBranch').value;
        recipients = customers.filter(c => c.status === 'Active' && c.branch === branch);
      }
      
      if (recipients.length === 0) {
        showToast('No recipients selected', 'error');
        return;
      }
      
      showLoading();
      
      // Simulate sending messages
      recipients.forEach(customer => {
        messageLog.push({
          customerId: customer.id,
          phone: customer.phone,
          email: customer.email,
          type: messageType,
          message: messageText,
          timestamp: new Date().toISOString(),
          status: 'sent'
        });
      });
      
      saveData();
      hideLoading();
      
      showToast(`Messages sent to ${recipients.length} customers!`, 'success');
      updateMetrics();
    }

    // Quick Message
    function quickMessage(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;
      
      const message = prompt(`Enter message for ${customer.firstName} ${customer.lastName}:`);
      if (message) {
        messageLog.push({
          customerId: customer.id,
          phone: customer.phone,
          type: 'whatsapp',
          message: message,
          timestamp: new Date().toISOString(),
          status: 'sent'
        });
        
        saveData();
        showToast('Message sent!', 'success');
        updateMetrics();
      }
    }

    // Export Data
    function exportData() {
      let csv = 'ID,FirstName,LastName,Phone,Email,Branch,Status,DOB,Anniversary,Address,Notes,Tags,AddedDate\n';
      
      customers.forEach(c => {
        csv += `"${c.id}","${c.firstName}","${c.lastName}","${c.phone}","${c.email}","${c.branch}","${c.status}","${c.dob}","${c.anniversary}","${c.address}","${c.notes}","${c.tags ? c.tags.join(';') : ''}","${c.addedDate}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `customers_export_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      
      showToast('Data exported successfully!', 'success');
    }

    // Backup Data
    function backupData() {
      const backup = {
        customers: customers,
        messageLog: messageLog,
        settings: settings,
        timestamp: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      showToast('Backup created successfully!', 'success');
    }

    // Clear All Data
    function clearAllData() {
      if (confirm('Are you sure you want to delete all data? This action cannot be undone!')) {
        customers = [];
        messageLog = [];
        localStorage.clear();
        renderCustomers();
        updateMetrics();
        showToast('All data cleared!', 'success');
      }
    }

    // Save Settings
    function saveSettings() {
      settings.companyName = document.getElementById('companyName').value;
      settings.companyPhone = document.getElementById('companyPhone').value;
      settings.companyEmail = document.getElementById('companyEmail').value;
      settings.enableRateLimit = document.getElementById('enableRateLimit').checked;
      settings.enableDeliveryReport = document.getElementById('enableDeliveryReport').checked;
      
      saveData();
      showToast('Settings saved successfully!', 'success');
    }

    // Generate Report
    function generateReport() {
      const report = {
        totalCustomers: customers.length,
        activeCustomers: customers.filter(c => c.status === 'Active').length,
        messagesSent: messageLog.length,
        branches: [...new Set(customers.map(c => c.branch))].length,
        generatedAt: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `report_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      showToast('Report generated successfully!', 'success');
    }

    // Initialize Charts
    function initCharts() {
      // Customer Growth Chart
      const growthCtx = document.getElementById('customerGrowthChart');
      if (growthCtx) {
        new Chart(growthCtx, {
          type: 'line',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
              label: 'New Customers',
              data: [12, 19, 15, 25, 22, 30],
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }

      // Branch Distribution Chart
      const branchCtx = document.getElementById('branchDistributionChart');
      if (branchCtx) {
        new Chart(branchCtx, {
          type: 'doughnut',
          data: {
            labels: ['Hamdan', 'Muroor', 'Shabiya 11', 'Al Barsha', 'Others'],
            datasets: [{
              data: [30, 25, 20, 15, 10],
              backgroundColor: [
                '#667eea',
                '#764ba2',
                '#28a745',
                '#ffc107',
                '#dc3545'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }

      // Message Stats Chart
      const messageCtx = document.getElementById('messageStatsChart');
      if (messageCtx) {
        new Chart(messageCtx, {
          type: 'bar',
          data: {
            labels: ['WhatsApp', 'SMS', 'Email'],
            datasets: [{
              label: 'Messages Sent',
              data: [150, 80, 45],
              backgroundColor: [
                '#25D366',
                '#007BFF',
                '#17a2b8'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }

      // Status Chart
      const statusCtx = document.getElementById('statusChart');
      if (statusCtx) {
        new Chart(statusCtx, {
          type: 'pie',
          data: {
            labels: ['Active', 'Inactive', 'Opt-Out'],
            datasets: [{
              data: [120, 20, 5],
              backgroundColor: [
                '#28a745',
                '#ffc107',
                '#dc3545'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
    }

    // Update Charts
    function updateCharts() {
      // Update chart data with real data
      // This would typically fetch real data and update the charts
    }

    // Show Loading
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }

    // Hide Loading
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    // Show Toast
    function showToast(message, type = 'success') {
      const toastHtml = `
        <div class="toast custom-toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;
      
      const toastContainer = document.querySelector('.toast-container');
      const toastElement = document.createElement('div');
      toastElement.innerHTML = toastHtml;
      toastContainer.appendChild(toastElement.firstElementChild);
      
      const toast = new bootstrap.Toast(toastContainer.lastElementChild);
      toast.show();
      
      setTimeout(() => {
        if (toastContainer.lastElementChild) {
          toastContainer.lastElementChild.remove();
        }
      }, 5000);
    }

    // Reset Form
    function resetForm() {
      document.getElementById('addCustomerForm').reset();
    }

    // Refresh Data
    function refreshData() {
      loadData();
      renderCustomers();
      updateMetrics();
      showToast('Data refreshed!', 'success');
    }
  </script>
</body>
</html>
